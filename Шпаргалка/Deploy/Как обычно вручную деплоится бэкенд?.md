> Ручной деплой бэкенда — это управляемая последовательность: **собрать артефакт → подготовить окружение и секреты → применить миграции → раскатить сервис с проверками → верифицировать и иметь понятный rollback**.  
> В моих проектах (Т-Банк) мы стараемся даже “ручной” деплой делать **без даунтайма**: blue-green/канареечный, с health-чеками и возможностью мгновенного отката.

---

## Базовый “скелет” ручного деплоя

1. **Подготовка**
    

- Выбрать версию (git tag/commit), собрать образ/артефакт.
    
- Проверить `.env`/секреты (vault/secret store), переменные окружения.
    
- Зафиксировать окно деплоя и уведомить смежников (если нужно).
    

2. **Доступ к инфраструктуре**
    

- VM: SSH на хост(ы).
    
- Docker/Compose: доступ к реестру образов.
    
- K8s: `kubectl`/`helm` с правильным контекстом и неймспейсом.
    

3. **Миграции БД**
    

- Бэкап критичных данных (минимум — дамп схемы).
    
- Прогнать миграции “вперёд”, совместимые по схеме (zero-downtime миграции).
    

4. **Выкатка**
    

- Запустить новый процесс/контейнер **рядышком** со старым (blue-green/канареечный).
    
- Пройти **readiness/liveness** и свой `/healthz`.
    
- Переключить трафик (reverse-proxy/ingress) на новый пул.
    

5. **Верификация**
    

- Smoke-тесты: ключевые ручки, бизнес-кейс end-to-end.
    
- Проверить метрики/логи/алерты (5xx, latency, error rate, consumer lag).
    

6. **Rollback план**
    

- Если что-то пошло не так — моментальный откат на предыдущий образ/релиз.
    
- При несовместимых миграциях — заранее подготовленный “down” сценарий или стратегия совместимых схем.
    

---

## Три типовых сценария (с командами)

### A) VM + systemd + Gunicorn/Uvicorn

```
# 1. Забираем код/собираем артефакт
ssh app@vm
cd /srv/app && git fetch && git checkout <tag>

python -m venv venv && source venv/bin/activate
pip install -r requirements.txt

# 2. Миграции (Alembic)
alembic upgrade head

# 3. Релоад без даунтайма
sudo systemctl reload app.service   # или graceful restart gunicorn
# 4. Проверка
curl -f http://localhost:8000/healthz
journalctl -u app.service -n 200 --no-pager

```

### B) Docker / Docker Compose (Blue-Green “на коленке”)


```
# 1. Тянем новый образ
docker pull registry/app:<tag>

# 2. Миграции в одноразовом контейнере
docker run --rm --network app-net registry/app:<tag> alembic upgrade head

# 3. Поднимаем новый стек рядом (green)
IMAGE_TAG=<tag> docker compose -f docker-compose.green.yml up -d

# 4. Health-check и переключение трафика (nginx/upstream → green)
# 5. Выводим старый (blue) из-под трафика и останавливаем
docker compose -f docker-compose.blue.yml down

```
### C) Kubernetes + Helm (канареечный/rollout)

```
# 1. Обновляем секреты/values
kubectl -n prod apply -f secrets.yaml

# 2. Миграции как Job (idempotent)
kubectl -n prod apply -f db-migrate-job.yaml
kubectl -n prod wait --for=condition=complete job/db-migrate

# 3. Частичный трафик на новую версию (канареечный)
helm upgrade app ./helm/app --set image.tag=<tag> --set rollout=canary

# 4. Следим за rollout и readiness
kubectl -n prod rollout status deploy/app
kubectl -n prod get pods -o wide

# 5. Промо до 100% или rollback
helm rollback app <prev-release>   # при необходимости

```

---

## Что важно не забыть

- **Секреты и конфиг**: хранить вне кода (Vault/K8s Secrets), не менять формат неожиданно.
    
- **Zero-downtime миграции**: сначала добавить колонки `NULL`, потом заполнять батчами, потом ограничения — чтобы старая и новая версии жили параллельно.
    
- **Зависимости** (Kafka/RabbitMQ): перед деплоем снизить `prefetch`/поставить на паузу консюмеры, после — постепенно наращивать.
    
- **Обратная совместимость контрактов** (Kafka schemas/REST): сначала расширяем (backward-compatible), только затем начинаем использовать новые поля.
    
- **Наблюдаемость**: дашборды (Prometheus/Grafana), логи (ELK/ Loki), трассировка (OpenTelemetry), алерты (lag, 5xx, p95).
    

---

## Мини-чек-лист “ручной выкладки” (реально помогаёт)

-  Образ/артефакт с нужным tag собран и в реестре.
    
-  Секреты/ENV обновлены и применены.
    
-  Миграции прогнаны и совместимы.
    
-  Health-чек зелёный, error-rate в норме.
    
-  Канареечный/blue-green переключился, старый инстанс жив до подтверждения.
    
-  План отката проверен: предыдущий tag доступен, команда rollback готова.