> –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —è –æ–±—ã—á–Ω–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—é –ø–æ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–π —Å—Ö–µ–º–µ **Prometheus + Grafana + Alertmanager**,  
> –∞ –µ—Å–ª–∏ —ç—Ç–æ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å –≤ Kubernetes, —Ç–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ ‚Äî **—ç–∫—Å–ø–æ—Ä—Ç–µ—Ä—ã, –ª–æ–≥–∏ –≤ Loki, —Ç—Ä–µ–π—Å—ã —á–µ—Ä–µ–∑ OpenTelemetry**.
> 
> –í –¢-–ë–∞–Ω–∫–µ —è –ø–æ–¥–Ω–∏–º–∞–ª –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –¥–ª—è –Ω–æ–≤—ã—Ö FastAPI-—Å–µ—Ä–≤–∏—Å–æ–≤: –Ω–∞—á–∏–Ω–∞–ª —Å —ç–∫—Å–ø–æ–∑–∏—Ü–∏–∏ `/metrics`, –ø–æ–¥–∫–ª—é—á–∞–ª Prometheus-scrape, —Å–æ–∑–¥–∞–≤–∞–ª –¥–∞—à–±–æ—Ä–¥—ã –∏ –∞–ª–µ—Ä—Ç—ã.
> 
> –û—Å–Ω–æ–≤–Ω–∞—è —Ü–µ–ª—å ‚Äî —Å–¥–µ–ª–∞—Ç—å —Å–µ—Ä–≤–∏—Å –Ω–∞–±–ª—é–¥–∞–µ–º—ã–º –ø–æ –º–æ–¥–µ–ª–∏ **RED (Rate, Errors, Duration)** –∏ –æ–±–µ—Å–ø–µ—á–∏—Ç—å SLO-–∫–æ–Ω—Ç—Ä–æ–ª—å.

---

## üîπ –ü–æ—à–∞–≥–æ–≤–æ: –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ ‚Äú—Å –Ω—É–ª—è‚Äù

### 1Ô∏è‚É£ –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏

–í –∫–æ–¥–µ –¥–æ–±–∞–≤–∏—Ç—å endpoint `/metrics` (—á–µ—Ä–µ–∑ `prometheus_client`):

```
from prometheus_client import Counter, Histogram, generate_latest, CONTENT_TYPE_LATEST
from fastapi import FastAPI, Request, Response
from time import perf_counter

app = FastAPI()
REQS = Counter("http_requests_total", "All HTTP requests", ["method", "path", "status"])
LAT  = Histogram("http_request_duration_seconds", "Latency", ["method", "path"])

@app.middleware("http")
async def collect_metrics(request: Request, call_next):
    start = perf_counter()
    response = await call_next(request)
    dur = perf_counter() - start
    REQS.labels(request.method, request.url.path, response.status_code).inc()
    LAT.labels(request.method, request.url.path).observe(dur)
    return response

@app.get("/metrics")
def metrics():
    return Response(generate_latest(), media_type=CONTENT_TYPE_LATEST)

```

–¢–µ–ø–µ—Ä—å —Å–µ—Ä–≤–∏—Å –æ—Ç–¥–∞—ë—Ç —Å–≤–æ–∏ –º–µ—Ç—Ä–∏–∫–∏ ‚Äî Prometheus —Å–º–æ–∂–µ—Ç –∏—Ö –∑–∞–±–∏—Ä–∞—Ç—å.

---

### 2Ô∏è‚É£ –ü–æ–¥–∫–ª—é—á–∏—Ç—å Prometheus

–í –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Prometheus (`prometheus.yml`) –ø—Ä–æ–ø–∏—Å—ã–≤–∞–µ–º —Ç–∞—Ä–≥–µ—Ç:

```
scrape_configs:
  - job_name: 'payments-api'
    metrics_path: /metrics
    static_configs:
      - targets: ['payments-api:8000']

```

‚Üí Prometheus —Ä–∞–∑ –≤ N —Å–µ–∫—É–Ω–¥ –æ–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Å–µ—Ä–≤–∏—Å –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –º–µ—Ç—Ä–∏–∫–∏.

–í Kubernetes —ç—Ç–æ –æ–±—ã—á–Ω–æ –¥–µ–ª–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `ServiceMonitor` (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **Prometheus Operator**):

```
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: payments-api
spec:
  selector:
    matchLabels:
      app: payments-api
  endpoints:
  - port: http
    path: /metrics
    interval: 15s

```

---

### 3Ô∏è‚É£ –î–æ–±–∞–≤–∏—Ç—å —ç–∫—Å–ø–æ—Ä—Ç–µ—Ä—ã

–ß—Ç–æ–±—ã –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –Ω–µ —Ç–æ–ª—å–∫–æ –∫–æ–¥, –Ω–æ –∏ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É:

- **node_exporter** ‚Äî CPU, RAM, FS
    
- **postgres_exporter** ‚Äî –ë–î (–∑–∞–¥–µ—Ä–∂–∫–∏, –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏)
    
- **kafka_exporter**, **rabbitmq_exporter** ‚Äî –±—Ä–æ–∫–µ—Ä—ã —Å–æ–æ–±—â–µ–Ω–∏–π
    
- **kube-state-metrics**, **cadvisor** ‚Äî Kubernetes
    
- **blackbox_exporter** ‚Äî –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –≤–Ω–µ—à–Ω–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ (HTTP/TCP –ø–∏–Ω–≥–∏)
    

---

### 4Ô∏è‚É£ –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Grafana

–ü–æ–¥–∫–ª—é—á–∞–µ–º Prometheus –∫–∞–∫ datasource ‚Üí —Å–æ–∑–¥–∞—ë–º –¥–∞—à–±–æ—Ä–¥—ã.  
–¢–∏–ø–∏—á–Ω–æ –¥–µ–ª–∞—é —Å–µ–∫—Ü–∏–∏:

- API-–º–µ—Ç—Ä–∏–∫–∏: RPS, Error rate, Latency (p95/p99)
    
- –ë—Ä–æ–∫–µ—Ä—ã: consumer lag, queue depth
    
- –ë–∞–∑–∞: deadlocks, slow queries
    
- –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞: CPU, memory, pod restarts
    
- –ë–∏–∑–Ω–µ—Å-–º–µ—Ç—Ä–∏–∫–∏: —É—Å–ø–µ—à–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è antifraud
    

> –í –¢-–ë–∞–Ω–∫–µ –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º –≥–æ—Ç–æ–≤—ã–µ —à–∞–±–ª–æ–Ω—ã –¥–∞—à–±–æ—Ä–¥–æ–≤ –∏–∑ JSON ‚Äî –ø—Ä–æ—Å—Ç–æ –ø–æ–¥–∫–ª—é—á–∞–µ–º —Å–µ—Ä–≤–∏—Å, –∏ Grafana –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ—Ç –ª–µ–π–±–ª—ã `service`, `env`.

---

### 5Ô∏è‚É£ –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–ª–µ—Ä—Ç—ã (Prometheus –∏–ª–∏ Grafana Alerting)

```
groups:
- name: api_alerts
  rules:
  - alert: HighErrorRate
    expr: rate(http_requests_total{status=~"5.."}[5m]) 
          / rate(http_requests_total[5m]) > 0.02
    for: 10m
    labels:
      severity: critical
    annotations:
      summary: "–û—à–∏–±–∫–∞ API >2%"
      runbook: "https://runbooks.tbank.local/payments/high-error-rate"

```

Alertmanager ‚Üí Slack/PagerDuty.

---

### 6Ô∏è‚É£ –ü–æ–¥–∫–ª—é—á–∏—Ç—å —Ç—Ä–µ–π—Å—ã –∏ –ª–æ–≥–∏

- OpenTelemetry SDK ‚Üí Tempo/Jaeger (`trace_id` —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –ª–æ–≥–∞–º–∏).
    
- –õ–æ–≥–∏ ‚Äî JSON –≤ stdout ‚Üí Fluent Bit ‚Üí Loki (–¥–∞–ª—å—à–µ –≤–∏–¥–Ω—ã –≤ Grafana).
    
- –ö–æ—Ä—Ä–µ–ª—è—Ü–∏—è: –∏–∑ –º–µ—Ç—Ä–∏–∫–∏ ‚Üí trace ‚Üí log ‚Üí stacktrace.
    

---

### 7Ô∏è‚É£ –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å SLO / SLI

- **SLO**: 99.9% —É—Å–ø–µ—à–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤, p95 < 200 –º—Å.
    
- **SLI**: –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è –≤ PromQL (–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω—ã—Ö/–≤—Å–µ—Ö).
    
- **–ê–ª–µ—Ä—Ç—ã** ‚Üí –ø–æ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—é –æ—Ç SLO.
    

---

### 8Ô∏è‚É£ –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å

- Helm chart —Å ServiceMonitor –∏ Dashboard provisioning.
    
- CI/CD (GitLab) ‚Üí –ø—Ä–∏ –¥–µ–ø–ª–æ–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç –¥–∞—à–±–æ—Ä–¥—ã –∏ –ø—Ä–∞–≤–∏–ª–∞.
    
- Runbook —Å—Å—ã–ª–∫–∏ –≤ –∞–Ω–Ω–æ—Ç–∞—Ü–∏—è—Ö –∞–ª–µ—Ä—Ç–æ–≤.
    

---

## üí¨ –ö–∞–∫ –º–æ–∂–Ω–æ –∫—Ä–∞—Å–∏–≤–æ –∑–∞–≤–µ—Ä—à–∏—Ç—å –æ—Ç–≤–µ—Ç

> –¢–æ –µ—Å—Ç—å –µ—Å–ª–∏ –∫—Ä–∞—Ç–∫–æ ‚Äî –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ ‚Äú—Å –Ω—É–ª—è‚Äù –≤—ã–≥–ª—è–¥–∏—Ç —Ç–∞–∫:  
> **–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ ‚Üí –º–µ—Ç—Ä–∏–∫–∏ ‚Üí Prometheus ‚Üí Grafana ‚Üí –∞–ª–µ—Ä—Ç—ã ‚Üí observability-–∫–æ—Ä—Ä–µ–ª—è—Ü–∏—è**.
> 
> –í –¢-–ë–∞–Ω–∫–µ —è –ø—Ä–æ—Ö–æ–¥–∏–ª —ç—Ç–æ—Ç –ø—É—Ç—å –Ω–µ —Ä–∞–∑: –æ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ `/metrics` –≤ FastAPI –¥–æ –≥–æ—Ç–æ–≤–æ–≥–æ Grafana-–¥–∞—à–±–æ—Ä–¥–∞ —Å –∞–ª–µ—Ä—Ç–∞–º–∏ –∏ SLO-–∫–æ–Ω—Ç—Ä–æ–ª–µ–º.
> 
> –í –∏—Ç–æ–≥–µ –∫–æ–º–∞–Ω–¥–∞ —Å—Ä–∞–∑—É –≤–∏–¥–∏—Ç, –µ—Å–ª–∏ —Ä–∞—Å—Ç—ë—Ç latency, consumer lag –∏–ª–∏ –ø–∞–¥–∞–µ—Ç –∫–æ–Ω–≤–µ—Ä—Å–∏—è, –∏ –º–æ–∂–µ—Ç —Ä–µ–∞–≥–∏—Ä–æ–≤–∞—Ç—å –∑–∞ –º–∏–Ω—É—Ç—ã.