Saga — это архитектурный шаблон, используемый для управления распределёнными транзакциями в микросервисных архитектурах. Он помогает координировать набор операций, которые должны выполняться последовательно, чтобы обеспечить согласованность данных в случае отказов или ошибок. (реализуется через сообщения в брокере)  
  
Saga делится на два типа:  
Оркестрированная Saga — когда центральный оркестратор управляет всеми шагами транзакции, отправляя команды каждому из сервисов и получая их отклик.  
Хореографированная Saga — когда сервисы взаимодействуют напрямую друг с другом через события. В случае успеха или ошибки каждый сервис сам решает, как реагировать на полученное событие и как выполнять свои операции.  
  
Отличия от 2pc (two-phase-commit):  
* Механизм согласования и управления:  
- Saga работает по принципу последовательных действий и компенсаций. Каждый шаг (операция) в транзакции выполняется независимо, а в случае ошибки или сбоя предыдущие шаги компенсируются откатами.  
- 2PC использует жёсткий централизованный подход для согласования всех участников. Координатор транзакции сначала собирает от всех участников подтверждение готовности (1-я фаза), а затем завершает транзакцию (2-я фаза) только если все участники согласны. Если кто-то не готов, происходит общий откат.  
* Терпимость к сбоям:  
- Saga лучше адаптирована для отказоустойчивых и распределённых систем. В случае сбоя отдельного шага происходит компенсация, а остальные участники продолжают работать. Это делает её более гибкой для микросервисных архитектур.  
- 2PC неустойчива к сбоям, так как центральный координатор представляет собой "точку отказа" (Single Point of Failure). Если координатор выходит из строя или один из участников отказывает, вся транзакция остаётся "подвешенной".  
* Масштабируемость:  
- Saga хорошо масштабируется в микросервисной архитектуре, так как не требует блокировок ресурсов. Каждый сервис работает независимо и обрабатывает шаги асинхронно.  
- 2PC плохо масштабируется в крупных распределённых системах из-за необходимости согласования и блокировки ресурсов для всех участников, что замедляет выполнение.  
* Использование и применимость:  
- Saga используется для долгоживущих, распределённых транзакций, которые могут быть откатаны через компенсационные действия (например, бронирование авиабилетов, где шаги могут отменяться).  
- 2PC подходит для случаев, когда нужна строгая согласованность и транзакции завершаются в течение короткого времени (например, банковские переводы внутри одной системы), но менее практична для распределённых микросервисных архитектур.  
Итог: Saga обеспечивает асинхронную, менее жёсткую согласованность с компенсационными действиями, а 2PC — строгую синхронную согласованность, жертвуя гибкостью и масштабируемостью.  
  
https://ibb.co/FWBDcxZ