
EXPLAIN и EXPLAIN ANALYZE — это команды SQL, которые помогают понять, как база данных планирует выполнить запрос. Они часто используются для анализа производительности и оптимизации запросов.  
  
1. EXPLAINКоманда EXPLAIN показывает план выполнения запроса, описывая, как база данных собирается получить данные. Она предоставляет информацию о том, какие индексы будут использоваться, в каком порядке будут обрабатываться таблицы, будет ли выполнено сканирование таблицы (Table Scan) или поиск по индексу (Index Scan), а также как связаны таблицы в сложных запросах.  
  
Особенности:  
  
- Не выполняет запрос, а только показывает план.  
- Быстрее, так как запрос не выполняется.  
- Полезно для предварительного анализа оптимизации запросов.  
2. EXPLAIN ANALYZE  
Команда EXPLAIN ANALYZE также показывает план выполнения запроса, но, в отличие от обычного EXPLAIN, реально выполняет запрос и замеряет время выполнения каждой операции.  
  
Особенности:  
  
- Выполняет запрос полностью и замеряет время выполнения каждой части плана(с осторожностью выполнять запросы на insert, update или delete.  
- Показывает фактическое время выполнения (в миллисекундах) и фактическое количество строк, обрабатываемых каждой операцией.  
- Полезно для детальной диагностики и более точной оптимизации производительности запроса.  
  
Предположим, у нас есть таблица orders, и мы выполняем следующий запрос:  
  
EXPLAIN (ANALYZE) SELECT * FROM orders WHERE status = 'completed' AND amount > 100;  
  
Пример результата EXPLAIN (ANALYZE)  
Результат может выглядеть примерно так:  
Seq Scan on orders (cost=0.00..35.00 rows=5 width=64) (actual time=0.005..0.015 rows=5 loops=1)  
Filter: ((status = 'completed'::text) AND (amount > 100))  
Rows Removed by Filter: 95  
Planning Time: 0.2 ms  
Execution Time: 0.05 ms  
  
Разбор результата  
Теперь рассмотрим каждую строку результата:  
1. Seq Scan on orders  
Seq Scan: PostgreSQL выбрал последовательное сканирование (Sequential Scan) таблицы orders, что означает, что он проверяет каждую строку. В этом примере не используется индекс, поэтому PostgreSQL сканирует всю таблицу.  
on orders: Указывает таблицу, на которой выполняется последовательное сканирование — в данном случае orders.  
2. (cost=0.00..35.00 rows=5 width=64)  
cost=0.00..35.00: Показывает приблизительную оценку стоимости выполнения запроса. Это относительные единицы, которые PostgreSQL использует для планирования.  
0.00 — начальная стоимость (инициирование сканирования).  
35.00 — итоговая стоимость после полного выполнения.  
rows=5: Оценка количества строк, которые будут возвращены запросом (предполагается 5 строк). Это значение может быть рассчитано на основе статистики таблицы.  
width=64: Оценка среднего размера одной строки в байтах. Это значение помогает PostgreSQL оценить объём данных, с которыми придётся работать.  
3. (actual time=0.005..0.015 rows=5 loops=1)  
actual time=0.005..0.015: Фактическое время выполнения узла плана (в миллисекундах).  
0.005 — время начала выполнения операции.  
0.015 — время завершения.  
rows=5: Фактическое количество строк, возвращённых в результате выполнения запроса.  
loops=1: Число проходов по этой операции. В данном случае это один проход (одна итерация), так как запрос выполнен один раз.  
4. Filter: ((status = 'completed'::text) AND (amount > 100))  
Filter:: Показывает фильтрацию, применённую к результатам сканирования.  
(status = 'completed'::text) AND (amount > 100): Условия фильтрации, использованные для выбора строк из orders. PostgreSQL применяет эти условия к каждой строке во время сканирования.  
5. Rows Removed by Filter: 95  
Rows Removed by Filter: 95: Указывает, что 95 строк не прошли фильтр и были исключены. Этот показатель полезен для понимания того, насколько селективны условия, и может указать, имеет ли смысл добавление индекса для фильтрации.  
6. Planning Time: 0.2 ms  
Planning Time: 0.2 ms: Время, потраченное PostgreSQL на планирование выполнения запроса, включая выбор подходящего плана (например, последовательное сканирование или использование индекса).  
7. Execution Time: 0.05 ms  
Execution Time: 0.05 ms: Общее время выполнения запроса (в миллисекундах). Это включает время фактического выполнения запроса, от начала сканирования до возвращения всех результатов.