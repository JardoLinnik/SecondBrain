> –í PostgreSQL –µ—Å—Ç—å **—Ä–∞–∑–Ω—ã–µ —É—Ä–æ–≤–Ω–∏ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫** ‚Äî –æ—Ç _—Å—Ç—Ä–æ–∫–æ–≤—ã—Ö (row-level)_ –¥–æ _—Ç–∞–±–ª–∏—á–Ω—ã—Ö (table-level)_.
> 
> **Table lock** –Ω–∞–≤–µ—à–∏–≤–∞–µ—Ç—Å—è, –∫–æ–≥–¥–∞ –æ–ø–µ—Ä–∞—Ü–∏—è —Ç—Ä–µ–±—É–µ—Ç —ç–∫—Å–∫–ª—é–∑–∏–≤–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ —Ç–∞–±–ª–∏—Ü—ã ‚Äî  
> –Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ö–µ–º—ã (`ALTER TABLE`), –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–∏ –∏–Ω–¥–µ–∫—Å–∞ –±–µ–∑ `CONCURRENTLY`, `VACUUM FULL`, `TRUNCATE`,  
> –∏–ª–∏ –ø—Ä–∏ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –º–∞—Å—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏—è—Ö (`DROP`, `REINDEX`, `CLUSTER`).
> 
> –¢–∞–∫–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –º–æ–≥—É—Ç **–æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ —á–∏—Ç–∞—é—â–∏–µ –∏ –ø–∏—à—É—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã** –∫ —Ç–∞–±–ª–∏—Ü–µ,  
> –ø–æ—ç—Ç–æ–º—É –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ –¢-–ë–∞–Ω–∫–µ) –º—ã –≤—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã ‚Äî `CONCURRENTLY`, –±–∞—Ç—á–∏, –∏ –≤—ã–ø–æ–ª–Ω—è–µ–º DDL-–æ–ø–µ—Ä–∞—Ü–∏–∏ —Ç–æ–ª—å–∫–æ –≤ maintenance-–æ–∫–Ω–∞—Ö.

---

## üîπ –ß—Ç–æ –≤–æ–æ–±—â–µ —Ç–∞–∫–æ–µ ‚Äútable lock‚Äù

PostgreSQL –Ω–∞–∫–ª–∞–¥—ã–≤–∞–µ—Ç **—Ç–∞–±–ª–∏—á–Ω—ã–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ (table-level locks)** —Ä–∞–∑–Ω—ã—Ö —Ä–µ–∂–∏–º–æ–≤ ‚Äî –æ—Ç ‚Äú–º—è–≥–∫–∏—Ö‚Äù –¥–æ ‚Äú–∂—ë—Å—Ç–∫–∏—Ö‚Äù.  
–û–Ω–∏ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—é—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ DDL –∏ DML, —á—Ç–æ–±—ã –Ω–µ –ø–æ–≤—Ä–µ–¥–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö.

–ö–∞–∂–¥–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –æ–¥–∏–Ω –∏–∑ **LockMode**, –∏ Postgres –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–µ—à–∞–µ—Ç, –∫–æ–≥–æ –ø—É—Å–∫–∞—Ç—å, –∫–æ–≥–æ ‚Äî –∂–¥–∞—Ç—å.

---

## üîπ –û—Å–Ω–æ–≤–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ —Å—Ç–∞–≤—è—Ç table lock

|–û–ø–µ—Ä–∞—Ü–∏—è|–¢–∏–ø –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏|–ß—Ç–æ –±–ª–æ–∫–∏—Ä—É–µ—Ç|–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π|
|---|---|---|---|
|`ALTER TABLE ...`|**ACCESS EXCLUSIVE**|–ü–æ–ª–Ω–æ—Å—Ç—å—é –±–ª–æ–∫–∏—Ä—É–µ—Ç —Ç–∞–±–ª–∏—Ü—É|–ù–µ–ª—å–∑—è —á–∏—Ç–∞—Ç—å –∏ –ø–∏—Å–∞—Ç—å|
|`DROP TABLE`|**ACCESS EXCLUSIVE**|–ü–æ–ª–Ω–æ—Å—Ç—å—é –±–ª–æ–∫–∏—Ä—É–µ—Ç —Ç–∞–±–ª–∏—Ü—É|–£–¥–∞–ª—è–µ—Ç –æ–±—ä–µ–∫—Ç|
|`TRUNCATE`|**ACCESS EXCLUSIVE**|–ü–æ–ª–Ω–æ—Å—Ç—å—é –±–ª–æ–∫–∏—Ä—É–µ—Ç —Ç–∞–±–ª–∏—Ü—É|–ë—ã—Å—Ç—Ä–æ –æ—á–∏—â–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—É|
|`VACUUM FULL`|**ACCESS EXCLUSIVE**|–ü–æ–ª–Ω–æ—Å—Ç—å—é –±–ª–æ–∫–∏—Ä—É–µ—Ç —Ç–∞–±–ª–∏—Ü—É|–ü–µ—Ä–µ—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—É|
|`REINDEX TABLE`|**ACCESS EXCLUSIVE**|–ü–æ–ª–Ω–æ—Å—Ç—å—é –±–ª–æ–∫–∏—Ä—É–µ—Ç —Ç–∞–±–ª–∏—Ü—É|–ò—Å–ø–æ–ª—å–∑—É–π `CONCURRENTLY`|
|`CLUSTER`|**ACCESS EXCLUSIVE**|–ü–æ–ª–Ω–æ—Å—Ç—å—é –±–ª–æ–∫–∏—Ä—É–µ—Ç —Ç–∞–±–ª–∏—Ü—É|–§–∏–∑–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ—É–ø–æ—Ä—è–¥–æ—á–∏–≤–∞–µ—Ç —Å—Ç—Ä–æ–∫–∏|
|`CREATE INDEX`|**ACCESS SHARE** / **SHARE UPDATE EXCLUSIVE**|–ë–ª–æ–∫–∏—Ä—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã|–ë–µ–∑ `CONCURRENTLY` –º–µ—à–∞–µ—Ç –∑–∞–ø–∏—Å–∏|
|`CREATE INDEX CONCURRENTLY`|**SHARE UPDATE EXCLUSIVE**|–ë–µ–∑ –ø–æ–ª–Ω–æ–π –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏|–ë–µ–∑–æ–ø–∞—Å–µ–Ω –≤ –ø—Ä–æ–¥–µ|
|`ANALYZE`|**ACCESS SHARE**|–ù–µ –º–µ—à–∞–µ—Ç DML|–ë–µ–∑–æ–ø–∞—Å–Ω–æ|
|`INSERT / UPDATE / DELETE`|**ROW EXCLUSIVE**|–õ—ë–≥–∫–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞|–ü–æ–∑–≤–æ–ª—è–µ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ DML|
|`SELECT ‚Ä¶ FOR UPDATE`|**ROW SHARE / ROW EXCLUSIVE**|–¢–æ–ª—å–∫–æ –¥–ª—è —Å—Ç—Ä–æ–∫|–ù–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –≤—Å—é —Ç–∞–±–ª–∏—Ü—É|

---

## üîπ –°–∞–º—ã–µ ¬´–æ–ø–∞—Å–Ω—ã–µ¬ª –æ–ø–µ—Ä–∞—Ü–∏–∏ (–ø–æ–ª–Ω—ã–π stop-the-world)

–û–Ω–∏ —Å—Ç–∞–≤—è—Ç **ACCESS EXCLUSIVE LOCK** ‚Äî —ç—Ç–æ —Å–∞–º–∞—è –∂—ë—Å—Ç–∫–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞.  
–í —ç—Ç–æ—Ç –º–æ–º–µ–Ω—Ç —Ç–∞–±–ª–∏—Ü—É –Ω–µ–ª—å–∑—è **–Ω–∏ —á–∏—Ç–∞—Ç—å, –Ω–∏ –ø–∏—Å–∞—Ç—å**.  
–ü—Ä–∏–º–µ—Ä—ã:

`ALTER TABLE users ADD COLUMN last_login timestamptz; VACUUM FULL users; REINDEX TABLE users; TRUNCATE users; DROP TABLE users;`

> ‚ö†Ô∏è –î–∞–∂–µ –ø—Ä–æ—Å—Ç–æ–π `ALTER TABLE ADD COLUMN` –±–ª–æ–∫–∏—Ä—É–µ—Ç –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å —Ç–∞–±–ª–∏—Ü–µ–π  
> –¥–æ –∫–æ–Ω—Ü–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏. –í –¢-–ë–∞–Ω–∫–µ —Ç–∞–∫–∏–µ –≤–µ—â–∏ –≤—Å–µ–≥–¥–∞ –∏–¥—É—Ç —á–µ—Ä–µ–∑ **zero-downtime –º–∏–≥—Ä–∞—Ü–∏–∏**.

---

## üîπ –ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã

|–û–ø–µ—Ä–∞—Ü–∏—è|–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç|
|---|---|
|`REINDEX`|`REINDEX CONCURRENTLY`|
|`CREATE INDEX`|`CREATE INDEX CONCURRENTLY`|
|`ALTER TABLE`|–î–µ–ª–∏–º –º–∏–≥—Ä–∞—Ü–∏–∏: —Å–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤–ª—è–µ–º —Å—Ç–æ–ª–±–µ—Ü `NULL`, –ø–æ—Ç–æ–º –∑–∞–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –±–∞—Ç—á–∞–º–∏|
|`VACUUM FULL`|–û–±—ã—á–Ω—ã–π `VACUUM` –∏–ª–∏ `pg_repack`|
|`TRUNCATE`|`DELETE` –±–∞—Ç—á–∞–º–∏ (–µ—Å–ª–∏ –Ω—É–∂–Ω—ã –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏)|

---

## üîπ –ü—Ä–∏–º–µ—Ä –∏–∑ –ø—Ä–∞–∫—Ç–∏–∫–∏ (–¢-–ë–∞–Ω–∫)

> –£ –Ω–∞—Å –±—ã–ª —Å–ª—É—á–∞–π, –∫–æ–≥–¥–∞ `ALTER TABLE ... ADD COLUMN` –Ω–∞ —Ç–∞–±–ª–∏—Ü–µ `transactions` (—Å–æ—Ç–Ω–∏ –º–∏–ª–ª–∏–æ–Ω–æ–≤ —Å—Ç—Ä–æ–∫)  
> –ø–æ—Å—Ç–∞–≤–∏–ª **ACCESS EXCLUSIVE lock** –∏ –ø–æ–≤–µ—Å–∏–ª –æ—á–µ—Ä–µ–¥—å –∏–∑ –¥–µ—Å—è—Ç–∫–æ–≤ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–æ–≤.
> 
> –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –º—ã –≤–Ω–µ–¥—Ä–∏–ª–∏ **zero-downtime –º–∏–≥—Ä–∞—Ü–∏–∏**:
> 
> - –¥–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–µ —Å `NULL` –±–µ–∑ `DEFAULT` (–º–≥–Ω–æ–≤–µ–Ω–Ω–æ, –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç);
>     
> - –ø–æ—Ç–æ–º –∞–ø–¥–µ–π—Ç–∏–º –¥–∞–Ω–Ω—ã–µ –±–∞—Ç—á–∞–º–∏ (–ø–æ `LIMIT 10000`);
>     
> - –ø–æ—Ç–æ–º —É–∂–µ –¥–æ–±–∞–≤–ª—è–µ–º `NOT NULL DEFAULT` (–∫–æ—Ä–æ—Ç–∫–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞);
>     
> - –∏ —Ç–æ–ª—å–∫–æ –≤ maintenance-–æ–∫–Ω–µ.
>     

üß∞ **–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:**  
`Alembic`, `Flyway`, `pg_repack`, `reindex concurrently`, `pg_stat_activity`, `pg_blocking_pids()`.

---

## üîπ –ö–∞–∫ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏

`SELECT   t.relname AS table_name,   l.mode,   l.locktype,   a.usename,   a.query,   a.state FROM pg_locks l JOIN pg_stat_activity a ON l.pid = a.pid JOIN pg_class t ON l.relation = t.oid WHERE t.relkind = 'r';`

‚Üí –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –∫—Ç–æ –¥–µ—Ä–∂–∏—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∏ –∫—Ç–æ –∂–¥—ë—Ç.  
–í –¢-–ë–∞–Ω–∫–µ –º—ã —Ç–∞–∫–∏–µ –º–µ—Ç—Ä–∏–∫–∏ —Å–Ω–∏–º–∞–µ–º Prometheus-—ç–∫—Å–ø–æ—Ä—Ç–µ—Ä–æ–º –∏ –∞–ª–µ—Ä—Ç–∏–º, –µ—Å–ª–∏ –∫—Ç–æ-—Ç–æ –¥–µ—Ä–∂–∏—Ç `ACCESS EXCLUSIVE` > 5 —Å–µ–∫—É–Ω–¥.

---

## üí¨ –ö–∞–∫ –º–æ–∂–Ω–æ –∫—Ä–∞—Å–∏–≤–æ –∑–∞–≤–µ—Ä—à–∏—Ç—å –æ—Ç–≤–µ—Ç

> –í —Ü–µ–ª–æ–º, **table lock** –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –ø—Ä–∏ DDL-–æ–ø–µ—Ä–∞—Ü–∏—è—Ö –∏–ª–∏ –ø—Ä–∏ –ø–æ–ª–Ω–æ–º –ø–µ—Ä–µ—É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ –¥–∞–Ω–Ω—ã—Ö.
> 
> –í –¢-–ë–∞–Ω–∫–µ –º—ã —Å—Ç—Ä–æ–≥–æ —Å–ª–µ–¥–∏–º, —á—Ç–æ–±—ã —Ç–∞–∫–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –Ω–µ –≤—ã–ø–æ–ª–Ω—è–ª–∏—Å—å –≤ —Ä–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è ‚Äî  
> –∏—Å–ø–æ–ª—å–∑—É–µ–º `CONCURRENTLY`, `pg_repack`, –∏ zero-downtime –º–∏–≥—Ä–∞—Ü–∏–∏,  
> –∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–≤–µ–¥–æ–º–ª—è–µ—Ç, –µ—Å–ª–∏ –∫—Ç–æ-—Ç–æ –¥–µ—Ä–∂–∏—Ç —Ç—è–∂—ë–ª—É—é –±–ª–æ–∫–∏—Ä–æ–≤–∫—É.
> 
> –ì–ª–∞–≤–Ω–∞—è —Ü–µ–ª—å ‚Äî **–∏–∑–±–µ–∂–∞—Ç—å ‚Äústop-the-world‚Äù —Å–∏—Ç—É–∞—Ü–∏–π** –Ω–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö –≤—Ä–æ–¥–µ `transactions`, `accounts`, `clients`.