> **Deadlock (–≤–∑–∞–∏–º–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞)** ‚Äî —ç—Ç–æ —Å–∏—Ç—É–∞—Ü–∏—è, –∫–æ–≥–¥–∞ **–Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –∂–¥—É—Ç –¥—Ä—É–≥ –¥—Ä—É–≥–∞ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ**,  
> –ø–æ—Ç–æ–º—É —á—Ç–æ –∫–∞–∂–¥–∞—è –∏–∑ –Ω–∏—Ö –¥–µ—Ä–∂–∏—Ç —Ä–µ—Å—É—Ä—Å—ã, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω—ã –¥—Ä—É–≥–æ–π.
> 
> –ù–∞–ø—Ä–∏–º–µ—Ä, —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è T1 –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∞ —Å—Ç—Ä–æ–∫—É A –∏ —Ö–æ—á–µ—Ç –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–æ–∫—É B,  
> –∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è T2 —É–∂–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∞ —Å—Ç—Ä–æ–∫—É B –∏ —Ö–æ—á–µ—Ç –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–æ–∫—É A ‚Äî  
> –æ–Ω–∏ –æ–±–µ –∂–¥—É—Ç, –∏ –Ω–∏–∫—Ç–æ –Ω–µ –º–æ–∂–µ—Ç –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å.
> 
> PostgreSQL –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ **–æ–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç —Ç–∞–∫–∏–µ —Ü–∏–∫–ª—ã –æ–∂–∏–¥–∞–Ω–∏—è** –∏ –∑–∞–≤–µ—Ä—à–∞–µ—Ç –æ–¥–Ω—É –∏–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π —Å –æ—à–∏–±–∫–æ–π `deadlock detected`,  
> —á—Ç–æ–±—ã –æ—Å—Ç–∞–ª—å–Ω—ã–µ –º–æ–≥–ª–∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Ä–∞–±–æ—Ç—É.

---

## üîπ –ü—Ä–∏–º–µ—Ä deadlock-–∞ (–∫–ª–∞—Å—Å–∏–∫–∞)

### üé¨ –°—Ü–µ–Ω–∞—Ä–∏–π:

1Ô∏è‚É£ –ü–µ—Ä–≤–∞—è —Å–µ—Å—Å–∏—è:

`BEGIN; UPDATE accounts SET balance = balance - 100 WHERE id = 1; -- –¥–µ—Ä–∂–∏—Ç lock –Ω–∞ account id=1`

2Ô∏è‚É£ –í—Ç–æ—Ä–∞—è —Å–µ—Å—Å–∏—è:

`BEGIN; UPDATE accounts SET balance = balance - 200 WHERE id = 2; -- –¥–µ—Ä–∂–∏—Ç lock –Ω–∞ account id=2`

–¢–µ–ø–µ—Ä—å –ø–µ—Ä–≤–∞—è —Ö–æ—á–µ—Ç –æ–±–Ω–æ–≤–∏—Ç—å –≤—Ç–æ—Ä—É—é —Å—Ç—Ä–æ–∫—É:

`UPDATE accounts SET balance = balance - 100 WHERE id = 2; -- –∂–¥—ë—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é #2`

–ê –≤—Ç–æ—Ä–∞—è ‚Äî –ø–µ—Ä–≤—É—é:

`UPDATE accounts SET balance = balance - 200 WHERE id = 1; -- –∂–¥—ë—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é #1`

üî• **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –æ–±–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∑–∞–≤–∏—Å–ª–∏ ‚Üí PostgreSQL —á–µ—Ä–µ–∑ –∫–æ—Ä–æ—Ç–∫–æ–µ –≤—Ä–µ–º—è –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç —Ü–∏–∫–ª  
–∏ –∑–∞–≤–µ—Ä—à–∞–µ—Ç –æ–¥–Ω—É —Å –æ—à–∏–±–∫–æ–π:

`ERROR:  deadlock detected DETAIL: Process 12345 waits for ShareLock on transaction 67890; blocked by process 67890.`

---

## üîπ –ö–∞–∫ PostgreSQL —ç—Ç–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç

- PostgreSQL –ø–æ—Å—Ç–æ—è–Ω–Ω–æ **–∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –≥—Ä–∞—Ñ –æ–∂–∏–¥–∞–Ω–∏–π –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫**.
    
- –ö–æ–≥–¥–∞ –≤–∏–¥–∏—Ç **—Ü–∏–∫–ª –æ–∂–∏–¥–∞–Ω–∏—è** (A –∂–¥—ë—Ç B, B –∂–¥—ë—Ç A) ‚Äî –æ–Ω **—É–±–∏–≤–∞–µ—Ç –æ–¥–Ω—É –∏–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π** (`ROLLBACK`),  
    —á—Ç–æ–±—ã —Å–Ω—è—Ç—å –≤–∑–∞–∏–º–Ω—É—é –±–ª–æ–∫–∏—Ä–æ–≤–∫—É.
    
- –ñ–¥–∞—Ç—å ¬´–≤–µ—á–Ω–æ¬ª –±–∞–∑–∞ –Ω–µ –±—É–¥–µ—Ç ‚Äî deadlock –≤—Å–µ–≥–¥–∞ —Ä–∞–∑—Ä–µ—à–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.
    

---

## üîπ –ü–æ—á–µ–º—É –æ–Ω–∏ –ø—Ä–æ–∏—Å—Ö–æ–¥—è—Ç

1. –†–∞–∑–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ **–æ–±–Ω–æ–≤–ª—è—é—Ç —Ä–µ—Å—É—Ä—Å—ã –≤ —Ä–∞–∑–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ**.
    
2. –î–æ–ª–≥–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (–¥–æ–ª–≥–æ –¥–µ—Ä–∂–∞—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏).
    
3. –ù–µ—è–≤–Ω—ã–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —á–µ—Ä–µ–∑ foreign keys).
    
4. –°–º–µ—à–∏–≤–∞–Ω–∏–µ DML (UPDATE/DELETE) –∏ DDL (ALTER TABLE) –≤ –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.
    
5. –¢—Ä–∏–≥–≥–µ—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –≤–Ω—É—Ç—Ä–∏ –æ–±–Ω–æ–≤–ª—è—é—Ç –¥—Ä—É–≥–∏–µ —Ç–∞–±–ª–∏—Ü—ã.
    

---

## üîπ –ö–∞–∫ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å deadlock-–∏

|–ú–µ—Ç–æ–¥|–û–ø–∏—Å–∞–Ω–∏–µ|
|---|---|
|üîÅ **–ï–¥–∏–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫**|–í—Å–µ–≥–¥–∞ –æ–±–Ω–æ–≤–ª—è–π —Ä–µ—Å—É—Ä—Å—ã –≤ –æ–¥–∏–Ω–∞–∫–æ–≤–æ–º –ø–æ—Ä—è–¥–∫–µ (–ø–æ ID, –Ω–∞–ø—Ä–∏–º–µ—Ä).|
|üß© **–ú–µ–ª–∫–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏**|–ß–µ–º –∫–æ—Ä–æ—á–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è, —Ç–µ–º –º–µ–Ω—å—à–µ —à–∞–Ω—Å –∑–∞—Å—Ç—Ä—è—Ç—å.|
|üïê **–¢–∞–π–º–∞—É—Ç –æ–∂–∏–¥–∞–Ω–∏—è –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫**|–ù–∞—Å—Ç—Ä–æ–∏—Ç—å `lock_timeout` –∏–ª–∏ `deadlock_timeout`.|
|üßç‚Äç‚ôÇÔ∏è **–ò–∑–±–µ–≥–∞–π —Ä—É—á–Ω—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –±–µ–∑ –Ω—É–∂–¥—ã**|–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π commit/rollback –±–µ–∑–æ–ø–∞—Å–Ω–µ–µ.|
|üß± **–ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã**|–ï—Å–ª–∏ Postgres –¥–µ–ª–∞–µ—Ç full scan, –æ–Ω –º–æ–∂–µ—Ç –∑–∞—Ö–≤–∞—Ç—ã–≤–∞—Ç—å –±–æ–ª—å—à–µ —Å—Ç—Ä–æ–∫, —á–µ–º –Ω—É–∂–Ω–æ.|
|üîí **–Ø–≤–Ω—ã–µ `FOR UPDATE` –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ**|–ß—Ç–æ–±—ã –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Ä—è–¥–æ–∫ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫.|

---

## üîπ –ö–∞–∫ —ç—Ç–æ –≤—ã–≥–ª—è–¥–∏—Ç –≤ –±–æ—é (–ø—Ä–∏–º–µ—Ä –∏–∑ –¢-–ë–∞–Ω–∫–∞)

> –í –¢-–ë–∞–Ω–∫–µ –º—ã –ª–æ–≤–∏–ª–∏ deadlock-–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–æ–≥–¥–∞ –¥–≤–µ –º–∏–∫—Ä–æ—Å–∏—Å—Ç–µ–º—ã  
> –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –æ–±–Ω–æ–≤–ª—è–ª–∏ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã `accounts` –∏ `transactions`:
> 
> - —Å–µ—Ä–≤–∏—Å —Ä–∞—Å—á—ë—Ç–æ–≤ –æ–±–Ω–æ–≤–ª—è–ª `accounts` ‚Üí `transactions`,
>     
> - —Å–µ—Ä–≤–∏—Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –æ–±–Ω–æ–≤–ª—è–ª `transactions` ‚Üí `accounts`.
>     
> 
> –ü—Ä–∏ –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ —ç—Ç–æ –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–º—É –≤–∑–∞–∏–º–Ω–æ–º—É –æ–∂–∏–¥–∞–Ω–∏—é.
> 
> –†–µ—à–∏–ª–∏ –ø—Ä–æ–±–ª–µ–º—É —Ç–∞–∫:
> 
> 1. –£—Å—Ç–∞–Ω–æ–≤–∏–ª–∏ **–µ–¥–∏–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫** ‚Äî –≤—Å–µ–≥–¥–∞ —Å–Ω–∞—á–∞–ª–∞ `accounts`, –ø–æ—Ç–æ–º `transactions`;
>     
> 2. –†–∞–∑–¥–µ–ª–∏–ª–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –Ω–∞ ‚Äú–ø–∏—à—É—â–∏–µ‚Äù –∏ ‚Äú–ª–æ–≥–∏—Ä—É—é—â–∏–µ‚Äù;
>     
> 3. –î–æ–±–∞–≤–∏–ª–∏ `lock_timeout = '2s'` –∏ retry-–º–µ—Ö–∞–Ω–∏–∫—É –≤ –∫–æ–¥–µ.
>     

üß∞ **–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:**  
`PostgreSQL`, `SQLAlchemy`, `pg_stat_activity`, `pg_locks`, `Grafana alerts`.

---

## üîπ –ö–∞–∫ –Ω–∞–π—Ç–∏ deadlock –≤ Postgres

`SELECT   a.pid,   a.usename,   a.query,   l.mode,   l.locktype,   l.relation::regclass FROM pg_locks l JOIN pg_stat_activity a ON l.pid = a.pid WHERE NOT l.granted;`

‚Üí –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –∫—Ç–æ –∂–¥—ë—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏.  
–ï—Å–ª–∏ deadlock –ø—Ä–æ–∏–∑–æ—à—ë–ª, PostgreSQL –∑–∞–ø–∏—à–µ—Ç –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –≤ `postgresql.log`.

---

## üí¨ –ö–∞–∫ –∫—Ä–∞—Å–∏–≤–æ –∑–∞–≤–µ—Ä—à–∏—Ç—å –æ—Ç–≤–µ—Ç

> –í —Ü–µ–ª–æ–º, **deadlock ‚Äî —ç—Ç–æ –≤–∑–∞–∏–º–Ω–æ–µ –æ–∂–∏–¥–∞–Ω–∏–µ –º–µ–∂–¥—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏**,  
> –∫–æ—Ç–æ—Ä–æ–µ PostgreSQL –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞–∑—Ä–µ—à–∞–µ—Ç, –∑–∞–≤–µ—Ä—à–∞—è –æ–¥–Ω—É –∏–∑ –Ω–∏—Ö.
> 
> –í –¢-–ë–∞–Ω–∫–µ –º—ã —Å—Ç–∞—Ä–∞–µ–º—Å—è –∏–∑–±–µ–≥–∞—Ç—å deadlock-–æ–≤ –∑–∞ —Å—á—ë—Ç  
> **–µ–¥–∏–Ω–æ–≥–æ –ø–æ—Ä—è–¥–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫, –∫–æ—Ä–æ—Ç–∫–∏—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π, –∏ —Ä–µ—Ç—Ä–∞–µ–≤ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö**.
> 
> –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç —Å–∏—Å—Ç–µ–º–µ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å—Å—è –±–µ–∑ —Å–±–æ–µ–≤ –¥–∞–∂–µ –ø–æ–¥ –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–æ–π.