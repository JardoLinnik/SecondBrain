**–°–∏—Ç—É–∞—Ü–∏—è:**  
–í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ —É –Ω–∞—Å –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ –≤—ã—Ä–æ—Å `consumer lag` –Ω–∞ —Å–µ—Ä–≤–∏—Å–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π ‚Äî —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ Kafka —Å—Ç–∞–ª–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å—Å—è —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π –¥–æ 6‚Äì8 –º–∏–Ω—É—Ç.  
–≠—Ç–æ –≤–ª–∏—è–ª–æ –Ω–∞–ø—Ä—è–º—É—é –Ω–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤: –ø—É—à–∏ –∏ email –ø—Ä–∏—Ö–æ–¥–∏–ª–∏ —Å –æ–ø–æ–∑–¥–∞–Ω–∏–µ–º, SLA –Ω–∞—Ä—É—à–∞–ª—Å—è, –Ω–∞—á–∞–ª–∏ –ø–æ—Å—Ç—É–ø–∞—Ç—å –∂–∞–ª–æ–±—ã –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É.

**–ü–æ—á–µ–º—É –∑–∞–¥–∞—á–∞ –±—ã–ª–∞ —Å–ª–æ–∂–Ω–∞—è:**

- –ü—Ä–æ–±–ª–µ–º–∞ –ø—Ä–æ—è–≤–ª—è–ª–∞—Å—å –Ω–µ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ, –∞ –≤–æ–ª–Ω–∞–º–∏.
    
- –ù–∞–≥—Ä—É–∑–∫—É –¥–µ—Ä–∂–∞–ª–∏ –¥–µ—Å—è—Ç–∫–∏ –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤ ‚Äî —Å–ª–æ–∂–Ω–æ –±—ã–ª–æ —Å—Ä–∞–∑—É –ø–æ–Ω—è—Ç—å, –≥–¥–µ –±—É—Ç—ã–ª–æ—á–Ω–æ–µ –≥–æ—Ä–ª—ã—à–∫–æ.
    
- –£—á–∞—Å—Ç–≤–æ–≤–∞–ª–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–Ω–µ—à–Ω–∏—Ö —Å–∏—Å—Ç–µ–º ‚Äî Kafka, PostgreSQL, –∞–Ω—Ç–∏—Ñ—Ä–æ–¥-—Å–µ—Ä–≤–∏—Å.
    

**–ú–æ–∏ –¥–µ–π—Å—Ç–≤–∏—è:**

1. –ù–∞—á–∞–ª —Å –Ω–∞–±–ª—é–¥–∞–µ–º–æ—Å—Ç–∏ ‚Äî –ø–æ—Å–º–æ—Ç—Ä–µ–ª –º–µ—Ç—Ä–∏–∫–∏ –≤ Grafana (consumer lag, processing time, throughput) –∏ –ª–æ–≥–∏ –≤ Loki.
    
2. –°—Ä–∞–≤–Ω–∏–ª –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ–¥–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–æ –∏ –ø–æ—Å–ª–µ –∏–Ω—Ü–∏–¥–µ–Ω—Ç–∞ ‚Äî –æ–∫–∞–∑–∞–ª–æ—Å—å, –∞–Ω—Ç–∏—Ñ—Ä–æ–¥ –Ω–∞—á–∞–ª –æ—Ç–≤–µ—á–∞—Ç—å –¥–æ–ª—å—à–µ.
    
3. –î–æ–±–∞–≤–∏–ª –≤—Ä–µ–º–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ `duration` –Ω–∞ –∫–∞–∂–¥–æ–º —à–∞–≥–µ –ø–∞–π–ø–ª–∞–π–Ω–∞, —á—Ç–æ–±—ã —Ç–æ—á–Ω–æ –ª–æ–∫–∞–ª–∏–∑–æ–≤–∞—Ç—å –º–µ–¥–ª–µ–Ω–Ω—ã–π —É—á–∞—Å—Ç–æ–∫.
    
4. –í–Ω—ë—Å –∏–∑–º–µ–Ω–µ–Ω–∏—è:
    
    - —Å–¥–µ–ª–∞–ª –∞–Ω—Ç–∏—Ñ—Ä–æ–¥-–∑–∞–ø—Ä–æ—Å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–º —Å —Ç–∞–π–º–∞—É—Ç–æ–º –∏ –∫—ç—à–µ–º;
        
    - –≤–≤—ë–ª batch-–æ–±—Ä–∞–±–æ—Ç–∫—É (200 —Å–æ–æ–±—â–µ–Ω–∏–π –∑–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –≤–º–µ—Å—Ç–æ 1);
        
    - —É–≤–µ–ª–∏—á–∏–ª –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∞—Ä—Ç–∏—Ü–∏–π –≤ Kafka –∏ –ø–µ—Ä–µ–Ω–∞—Å—Ç—Ä–æ–∏–ª –ø–∞—Ä–∞–º–µ—Ç—Ä—ã `max.poll.records` –∏ `fetch.max.bytes`.
        
5. –í–Ω—ë—Å –∑–∞—â–∏—Ç—É –æ—Ç –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏ ‚Äî –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ –≤–æ—Ä–∫–µ—Ä–∞ –∏ –∞–ª–µ—Ä—Ç—ã –Ω–∞ —Ä–æ—Å—Ç lag.
    

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**

- Lag —Å–Ω–∏–∑–∏–ª—Å—è —Å 6‚Äì8 –º–∏–Ω—É—Ç –¥–æ 10‚Äì15 —Å–µ–∫—É–Ω–¥.
    
- –í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ–¥–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è —É–ø–∞–ª–æ —Å 300 –º—Å –¥–æ 50 –º—Å.
    
- SLA –ø–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º –≤–µ—Ä–Ω—É–ª—Å—è –≤ –Ω–æ—Ä–º—É.
    
- –ú—ã –¥–æ–±–∞–≤–∏–ª–∏ runbook –∏ –¥–∞—à–±–æ—Ä–¥ —Å –ø–∞—Ä—Ç–∏—Ü–∏—è–º–∏ –∏ –ª–∞–≥–∞–º–∏ ‚Äî —Ç–µ–ø–µ—Ä—å –º–æ–∂–µ–º –∑–∞—Ä–∞–Ω–µ–µ –∑–∞–º–µ—á–∞—Ç—å –∞–Ω–æ–º–∞–ª–∏–∏.
    

---

## üí¨ –ö–∞–∫ –º–æ–∂–Ω–æ —Å–∫–∞–∑–∞—Ç—å —ç—Ç–æ —É—Å—Ç–Ω–æ (–Ω–∞ 40‚Äì50 —Å–µ–∫—É–Ω–¥)

> –ë—ã–ª–∞ —Å–∏—Ç—É–∞—Ü–∏—è: –≤ –ø—Ä–æ–¥–µ —Ä–µ–∑–∫–æ –≤—ã—Ä–æ—Å lag –≤ Kafka ‚Äî —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —à–ª–∏ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π. –≠—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ, –ø–æ—Ç–æ–º—É —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –ø–æ–ª—É—á–∞–ª–∏ –ø—É—à–∏ –≤–æ–≤—Ä–µ–º—è.
> 
> –ü—Ä–æ–±–ª–µ–º–∞ –±—ã–ª–∞ —Å–ª–æ–∂–Ω–æ–π: –ª–∞–≥ –Ω–∞—Ä–∞—Å—Ç–∞–ª –≤–æ–ª–Ω–∞–º–∏, –º–µ—Ç—Ä–∏–∫–∏ –Ω–µ —Å—Ä–∞–∑—É –ø–æ–∫–∞–∑—ã–≤–∞–ª–∏ –∏—Å—Ç–æ—á–Ω–∏–∫ ‚Äî –Ω—É–∂–Ω–æ –±—ã–ª–æ –ø–æ–Ω—è—Ç—å, —á—Ç–æ —Ç–æ—Ä–º–æ–∑–∏—Ç –ø–∞–π–ø–ª–∞–π–Ω.
> 
> –Ø –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª –º–µ—Ç—Ä–∏–∫–∏ –∏ –ª–æ–≥–∏, –ª–æ–∫–∞–ª–∏–∑–æ–≤–∞–ª –ø—Ä–æ–±–ª–µ–º—É ‚Äî –≤–Ω–µ—à–Ω–∏–π –∞–Ω—Ç–∏—Ñ—Ä–æ–¥ –Ω–∞—á–∞–ª –æ—Ç–≤–µ—á–∞—Ç—å –º–µ–¥–ª–µ–Ω–Ω–µ–µ.
> 
> –ü–µ—Ä–µ–ø–∏—Å–∞–ª —á–∞—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–∞ batch, —Å–¥–µ–ª–∞–ª –∞–Ω—Ç–∏—Ñ—Ä–æ–¥-–∑–∞–ø—Ä–æ—Å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–º —Å –∫—ç—à–µ–º, —Ä–∞—Å—à–∏—Ä–∏–ª –ø–∞—Ä—Ç–∏—Ü–∏–∏ Kafka.
> 
> –í –∏—Ç–æ–≥–µ –ª–∞–≥ —É–ø–∞–ª —Å 8 –º–∏–Ω—É—Ç –¥–æ 10 —Å–µ–∫—É–Ω–¥, SLA –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–ª—Å—è.  
> –î–æ–±–∞–≤–∏–ª–∏ –∞–ª–µ—Ä—Ç—ã –∏ runbook, —á—Ç–æ–±—ã –±–æ–ª—å—à–µ –Ω–µ –ª–æ–≤–∏—Ç—å —ç—Ç–æ –≤—Ä—É—á–Ω—É—é.




# PostgreSQL –º–∏–≥—Ä–∞—Ü–∏—é –±–µ–∑ –¥–∞—É–Ω—Ç–∞–π–º–∞

**–°–∏—Ç—É–∞—Ü–∏—è:**  
–ú—ã –≤ –¢-–ë–∞–Ω–∫–µ –¥–æ–±–∞–≤–ª—è–ª–∏ –Ω–æ–≤–æ–µ –ø–æ–ª–µ `status` –≤ –±–æ–ª—å—à—É—é —Ç–∞–±–ª–∏—Ü—É –∑–∞–∫–∞–∑–æ–≤ (`orders`, ~120 –º–ª–Ω —Å—Ç—Ä–æ–∫).  
–ó–∞–¥–∞—á–∞ –∫–∞–∑–∞–ª–∞—Å—å –ø—Ä–æ—Å—Ç–æ–π ‚Äî –ø—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É `NOT NULL DEFAULT 'new'`.  
–ù–æ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ —ç—Ç–æ –ø—Ä–∏–≤–µ–ª–æ –∫ –ø—Ä–æ–±–ª–µ–º–µ: –º–∏–≥—Ä–∞—Ü–∏—è –ø–æ–≤–∏—Å–ª–∞, API –Ω–∞—á–∞–ª–∏ –æ—Ç–¥–∞–≤–∞—Ç—å 5xx, –≤—Ä–µ–º—è –æ—Ç–∫–ª–∏–∫–∞ –ë–î –≤—ã—Ä–æ—Å–ª–æ –≤ 10 —Ä–∞–∑.

**–ü–æ—á–µ–º—É —ç—Ç–æ –±—ã–ª–æ —Å–ª–æ–∂–Ω–æ:**

- –ò–∑-–∑–∞ `DEFAULT` –∏ `NOT NULL` PostgreSQL **–ø–µ—Ä–µ–ø–∏—Å–∞–ª –≤—Å—é —Ç–∞–±–ª–∏—Ü—É** ‚Äî —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏ —Å–¥–µ–ª–∞–ª full rewrite, –±–ª–æ–∫–∏—Ä—É—è –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏.
    
- –¢–∞–±–ª–∏—Ü–∞ –∞–∫—Ç–∏–≤–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞—Å—å –ø–ª–∞—Ç–µ–∂–Ω—ã–º API ‚Äî –¥–∞–∂–µ –∫–æ—Ä–æ—Ç–∫–∏–π lock –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –ø—Ä–∏–≤–æ–¥–∏–ª –∫ –æ—à–∏–±–∫–∞–º –≤ –ø—Ä–æ–¥–µ.
    
- –ù—É–∂–Ω–æ –±—ã–ª–æ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ö–µ–º—É **–±–µ–∑ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–µ—Ä–≤–∏—Å–∞**, —Ç.–µ. –±–µ–∑ `ACCESS EXCLUSIVE`-–±–ª–æ–∫–∏—Ä–æ–≤–æ–∫.
    

**–ú–æ–∏ –¥–µ–π—Å—Ç–≤–∏—è:**

1. **–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª pg_stat_activity –∏ pg_locks** ‚Äî —É–≤–∏–¥–µ–ª, —á—Ç–æ –±–ª–æ–∫ –¥–µ—Ä–∂–∏—Ç—Å—è –Ω–∞ DDL-–æ–ø–µ—Ä–∞—Ü–∏–∏.
    
2. –†–µ—à–∏–ª –ø—Ä–æ–≤–µ—Å—Ç–∏ –º–∏–≥—Ä–∞—Ü–∏—é **–≤ –Ω–µ—Å–∫–æ–ª—å–∫–æ –±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö —à–∞–≥–æ–≤**:
    
    1. –î–æ–±–∞–≤–∏–ª –∫–æ–ª–æ–Ω–∫—É _nullable_, –±–µ–∑ –¥–µ—Ñ–æ–ª—Ç–∞ (–æ–ø–µ—Ä–∞—Ü–∏—è –º–≥–Ω–æ–≤–µ–Ω–Ω–∞—è):
        
        `ALTER TABLE orders ADD COLUMN status text NULL;`
        
    2. –°–¥–µ–ª–∞–ª **—Ñ–æ–Ω–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ** –±–∞—Ç—á–∞–º–∏ –ø–æ 50‚Äì100 —Ç—ã—Å. —Å—Ç—Ä–æ–∫:
        
        `UPDATE orders  SET status = 'new'  WHERE status IS NULL  AND id BETWEEN :from_id AND :to_id;`
        
        –ó–∞–ø—É—Å–∫–∞–ª –∏–∑ Celery-–≤–æ—Ä–∫–µ—Ä–∞ —Å –ø–∞—É–∑–∞–º–∏, —á—Ç–æ–±—ã –Ω–µ –Ω–∞–≥—Ä—É–∂–∞—Ç—å –¥–∏—Å–∫.
        
    3. –°–æ–∑–¥–∞–ª –∏–Ω–¥–µ–∫—Å **CONCURRENTLY**, —á—Ç–æ–±—ã –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —á—Ç–µ–Ω–∏—è.
        
    4. –î–æ–±–∞–≤–∏–ª `DEFAULT 'new'` –¥–ª—è –Ω–æ–≤—ã—Ö –∑–∞–ø–∏—Å–µ–π (–±—ã—Å—Ç—Ä–æ, –±–µ–∑ –ø–µ—Ä–µ–ø–∏—Å–∏ —Å—Ç–∞—Ä—ã—Ö).
        
    5. –ü—Ä–æ–≤–µ—Ä–∏–ª, —á—Ç–æ –≤—Å–µ —Å—Ç—Ä–æ–∫–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã ‚Üí –¥–æ–±–∞–≤–∏–ª **CHECK NOT VALID**, –∞ –ø–æ—Ç–æ–º **VALIDATE CONSTRAINT**.
        
        `ALTER TABLE orders ADD CONSTRAINT status_nn CHECK (status IS NOT NULL) NOT VALID; ALTER TABLE orders VALIDATE CONSTRAINT status_nn;`
        
3. –î–æ–±–∞–≤–∏–ª –∞–ª–µ—Ä—Ç—ã –Ω–∞ –¥–æ–ª–≥–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (`pg_stat_activity`) –∏ deadlocks –≤ Grafana.
    
4. –ü–æ–¥–≥–æ—Ç–æ–≤–∏–ª **runbook ‚Äú–ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ DDL –≤ PostgreSQL‚Äù** ‚Äî —Ç–µ–ø–µ—Ä—å —ç—Ç–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç –∫–æ–º–∞–Ω–¥—ã.
    

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**

- –ú–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞ **–±–µ–∑ –¥–∞—É–Ω—Ç–∞–π–º–∞**, API –Ω–µ –≤—ã–¥–∞–ª–æ –Ω–∏ –æ–¥–Ω–æ–≥–æ 5xx.
    
- –í—Ä–µ–º—è –æ—Ç–∫–ª–∏–∫–∞ –ë–î –Ω–µ –≤—ã—Ä–æ—Å–ª–æ, TPS –æ—Å—Ç–∞–ª—Å—è —Å—Ç–∞–±–∏–ª—å–Ω—ã–º.
    
- –°–æ–∑–¥–∞–ª–∏ —à–∞–±–ª–æ–Ω –¥–ª—è –±—É–¥—É—â–∏—Ö –º–∏–≥—Ä–∞—Ü–∏–π, —á—Ç–æ–±—ã –±–æ–ª—å—à–µ –Ω–µ –ø–æ–≤—Ç–æ—Ä—è—Ç—å —ç—Ç—É –æ—à–∏–±–∫—É.
    
- –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –∫–æ–º–∞–Ω–¥–∞ –Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–æ–¥–∏—Ç—å –≤—Å–µ DDL-–æ–ø–µ—Ä–∞—Ü–∏–∏ —Ç–æ–ª—å–∫–æ –≤ ‚Äúlazy-—Ä–µ–∂–∏–º–µ‚Äù: `ADD NULLABLE ‚Üí backfill ‚Üí DEFAULT ‚Üí VALIDATE`.
    

---

## üí¨ –ö–∞–∫ –º–æ–∂–Ω–æ —Å–∫–∞–∑–∞—Ç—å —ç—Ç–æ —É—Å—Ç–Ω–æ (–Ω–∞ 40‚Äì50 —Å–µ–∫—É–Ω–¥)

> –£ –Ω–∞—Å –±—ã–ª–∞ —Å–∏—Ç—É–∞—Ü–∏—è: –Ω—É–∂–Ω–æ –±—ã–ª–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ –ø–æ–ª–µ –≤ —Ç–∞–±–ª–∏—Ü—É `orders` —Å —Å–æ—Ç–Ω—è–º–∏ –º–∏–ª–ª–∏–æ–Ω–æ–≤ —Å—Ç—Ä–æ–∫.
> 
> –ü–µ—Ä–≤—ã–π –≤–∞—Ä–∏–∞–Ω—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ –≤—ã–∑–≤–∞–ª –±–ª–æ–∫–∏—Ä–æ–≤–∫—É ‚Äî PostgreSQL –ø–µ—Ä–µ–ø–∏—Å–∞–ª –≤—Å—é —Ç–∞–±–ª–∏—Ü—É –∏–∑-–∑–∞ `NOT NULL DEFAULT`, –∏ —á–∞—Å—Ç—å API –ø–æ—à–ª–∞ –≤ 5xx.
> 
> –Ø —Ä–∞–∑–æ–±—Ä–∞–ª—Å—è –≤ –º–µ—Ö–∞–Ω–∏–∫–µ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫, –∏ –ø–µ—Ä–µ–ø–∏—Å–∞–ª –º–∏–≥—Ä–∞—Ü–∏—é –ø–æ—ç—Ç–∞–ø–Ω–æ: –¥–æ–±–∞–≤–∏–ª nullable-–∫–æ–ª–æ–Ω–∫—É, –∑–∞–ø–æ–ª–Ω–∏–ª –¥–∞–Ω–Ω—ã–µ –±–∞—Ç—á–∞–º–∏, –ø–æ—Ç–æ–º –ø–æ—Å—Ç–∞–≤–∏–ª –¥–µ—Ñ–æ–ª—Ç –∏ `CHECK NOT VALID` ‚Üí `VALIDATE`.
> 
> –í—Å—ë –ø—Ä–æ—à–ª–æ –±–µ–∑ –¥–∞—É–Ω—Ç–∞–π–º–∞, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –¥–∞–∂–µ –Ω–µ –∑–∞–º–µ—Ç–∏–ª–∏.  
> –¢–µ–ø–µ—Ä—å —É –Ω–∞—Å –µ—Å—Ç—å –≥–æ—Ç–æ–≤—ã–π —à–∞–±–ª–æ–Ω ‚Äú–±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö DDL-–æ–ø–µ—Ä–∞—Ü–∏–π‚Äù ‚Äî –≤—Å–µ –∫—Ä—É–ø–Ω—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–æ–≤–æ–¥–∏–º —Ç–æ–ª—å–∫–æ —Ç–∞–∫.



# –ø—Ä–æ–±–ª–µ–º–∞ —Å Redis cache stampede

**–°–∏—Ç—É–∞—Ü–∏—è:**  
–í –æ–¥–Ω–æ–º –∏–∑ –Ω–∞—à–∏—Ö –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–æ–≤ –≤ –¢-–ë–∞–Ω–∫–µ, –∫–æ—Ç–æ—Ä—ã–π –æ–±—Å–ª—É–∂–∏–≤–∞–µ—Ç –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏ –∏ –ª–∏–º–∏—Ç—ã –¥–ª—è —Ä–∞—Å—á—ë—Ç–æ–≤, –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –Ω–∞–±–ª—é–¥–∞–ª–∏—Å—å –≤—Å–ø–ª–µ—Å–∫–∏ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ PostgreSQL.  
–°–µ—Ä–≤–∏—Å—ã, –∫–æ—Ç–æ—Ä—ã–µ –¥–æ–ª–∂–Ω—ã –±—ã–ª–∏ —á–∏—Ç–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ Redis-–∫—ç—à–∞, –≤–Ω–µ–∑–∞–ø–Ω–æ –Ω–∞—á–∏–Ω–∞–ª–∏ –º–∞—Å—Å–æ–≤–æ –±–∏—Ç—å –≤ –±–∞–∑—É.  
–≠—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–æ –ø—Ä–∏–º–µ—Ä–Ω–æ —Ä–∞–∑ –≤ —á–∞—Å ‚Äî —Ä–æ–≤–Ω–æ –≤ –º–æ–º–µ–Ω—Ç, –∫–æ–≥–¥–∞ –∏—Å—Ç–µ–∫–∞–ª TTL —É –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –∫–ª—é—á–µ–π.

**–ü–æ—á–µ–º—É –∑–∞–¥–∞—á–∞ –±—ã–ª–∞ —Å–ª–æ–∂–Ω–æ–π:**

- –ü—Ä–æ–±–ª–µ–º–∞ –ø—Ä–æ—è–≤–ª—è–ª–∞—Å—å **—Ç–æ–ª—å–∫–æ –ø–æ–¥ –Ω–∞–≥—Ä—É–∑–∫–æ–π**, –∏ –Ω–µ –≤—Å–µ–≥–¥–∞ –Ω–∞ —Ç–µ—Å—Ç–µ.
    
- Redis ‚Äú–æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ‚Äù —Ä–∞–±–æ—Ç–∞–ª ‚Äî –º–µ—Ç—Ä–∏–∫–∏ –Ω–µ —Å–∏–≥–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª–∏ –æ—à–∏–±–æ–∫.
    
- –°–ª–æ–∂–Ω–æ –±—ã–ª–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏: —à—Ç–æ—Ä–º –¥–ª–∏–ª—Å—è 10‚Äì15 —Å–µ–∫—É–Ω–¥, –Ω–æ –ø—Ä–∏–≤–æ–¥–∏–ª –∫ —Ä–æ—Å—Ç—É latency API –∏ –ø—Ä–æ—Å–∞–¥–∫–µ SLA.
    

**–ú–æ–∏ –¥–µ–π—Å—Ç–≤–∏—è:**

1. **–°–æ–±—Ä–∞–ª –º–µ—Ç—Ä–∏–∫–∏ –∏ –ª–æ–≥–∏:**
    
    - –í Grafana –∑–∞–º–µ—Ç–∏–ª –∫–æ—Ä—Ä–µ–ª—è—Ü–∏—é –º–µ–∂–¥—É –ø–∞–¥–µ–Ω–∏–µ–º `cache_hit_ratio` –∏ —Ä–æ—Å—Ç–æ–º `db_qps`.
        
    - –ß–µ—Ä–µ–∑ Loki –Ω–∞—à—ë–ª, —á—Ç–æ —Ç—ã—Å—è—á–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –æ–¥–Ω–æ–º—É –∏ —Ç–æ–º—É –∂–µ –∫–ª—é—á—É (`limits:config`) –ø—Ä–∏—Ö–æ–¥—è—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ.
        
2. **–í—ã—è—Å–Ω–∏–ª –ø—Ä–∏—á–∏–Ω—É:**  
    –ü—Ä–∏ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ TTL Redis —É–¥–∞–ª—è–ª –∫–ª—é—á, –∏ –≤—Å–µ –∫–ª–∏–µ–Ω—Ç—ã –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –≤–∏–¥–µ–ª–∏ ‚Äú–ø—Ä–æ–º–∞—Ö‚Äù, –Ω–∞—á–∏–Ω–∞–ª–∏ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –∏ –ø–∏—Å–∞—Ç—å –µ–≥–æ –æ–±—Ä–∞—Ç–Ω–æ ‚Äî –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π **cache stampede**.
    
3. **–†–µ–∞–ª–∏–∑–æ–≤–∞–ª –∑–∞—â–∏—Ç—É:**
    
    - –î–æ–±–∞–≤–∏–ª **—Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–π lock** –≤ Redis (`SETNX` —Å TTL) ‚Äî –ø–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ, –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∂–¥—É—Ç.
        
    - –í–≤—ë–ª **early refresh**: –ø—Ä–∏ `TTL < 10%` –¥–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∑–∞—Ä–∞–Ω–µ–µ –≤ —Ñ–æ–Ω–µ.
        
    - TTL —Ç–µ–ø–µ—Ä—å –∑–∞–¥–∞—ë–º —Å **–¥–∂–∏—Ç—Ç–µ—Ä–æ–º ¬±20%**, —á—Ç–æ–±—ã –∏—Å—Ç–µ—á–µ–Ω–∏—è –Ω–µ —Å–æ–≤–ø–∞–¥–∞–ª–∏.
        
    - –î–æ–±–∞–≤–∏–ª fallback: –µ—Å–ª–∏ –∫–ª—é—á –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, –Ω–æ –µ—Å—Ç—å —Å—Ç–∞—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ (–ø–∞—Ç—Ç–µ—Ä–Ω _stale-while-revalidate_).
        
4. –û–±–Ω–æ–≤–∏–ª –Ω–∞—à–∏ –æ–±—â–∏–µ —É—Ç–∏–ª–∏—Ç—ã –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è ‚Äî —á—Ç–æ–±—ã —ç—Ç–æ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω –ø—Ä–∏–º–µ–Ω—è–ª—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–æ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–∞—Ö.
    
5. –î–æ–±–∞–≤–∏–ª –∞–ª–µ—Ä—Ç—ã –Ω–∞ ‚Äú–≤—Å–ø–ª–µ—Å–∫–∏ TTL-—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏‚Äù –∏ —Å–Ω–∏–∂–µ–Ω–∏–µ hit-ratio.
    

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**

- –ü–∏–∫–∏ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –ë–î –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏—Å—á–µ–∑–ª–∏.
    
- p95 latency —É–ø–∞–ª –Ω–∞ 35‚Äì40%.
    
- `cache_hit_ratio` —Å—Ç–∞–±–∏–ª–∏–∑–∏—Ä–æ–≤–∞–ª—Å—è > 97%.
    
- –û—à–∏–±–æ–∫ —Ç–∞–π–º–∞—É—Ç–∞ —Å—Ç–∞–ª–æ –≤ 5 —Ä–∞–∑ –º–µ–Ω—å—à–µ.
    
- –≠—Ç–æ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω –º—ã —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤ —à–∞–±–ª–æ–Ω–∞—Ö FastAPI-—Å–µ—Ä–≤–∏—Å–æ–≤.
    

---

## üí¨ –ö–∞–∫ –º–æ–∂–Ω–æ —Å–∫–∞–∑–∞—Ç—å —É—Å—Ç–Ω–æ (–Ω–∞ 40‚Äì50 —Å–µ–∫—É–Ω–¥)

> –£ –Ω–∞—Å –±—ã–ª–∞ —Å–∏—Ç—É–∞—Ü–∏—è: —Å–µ—Ä–≤–∏—Å –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –Ω–∞—á–∏–Ω–∞–ª —Å–∏–ª—å–Ω–æ –≥—Ä—É–∑–∏—Ç—å –±–∞–∑—É ‚Äî –æ—Å–æ–±–µ–Ω–Ω–æ –≤ –º–æ–º–µ–Ω—Ç—ã, –∫–æ–≥–¥–∞ –∏—Å—Ç–µ–∫–∞–ª TTL —É –∫—ç—à–∞ –≤ Redis.
> 
> –Ø –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª –º–µ—Ç—Ä–∏–∫–∏ –∏ –ø–æ–Ω—è–ª, —á—Ç–æ –≤—Å–µ –∫–ª–∏–µ–Ω—Ç—ã –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –≤–∏–¥—è—Ç ‚Äú–ø—Ä–æ–º–∞—Ö‚Äù –∏ –Ω–∞—á–∏–Ω–∞—é—Ç –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—Ç—å –æ–¥–Ω–æ –∏ —Ç–æ –∂–µ ‚Äî –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π cache stampede.
> 
> –†–µ–∞–ª–∏–∑–æ–≤–∞–ª –∑–∞—â–∏—Ç—É: –¥–æ–±–∞–≤–∏–ª —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–π lock, —Ä–∞–Ω–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—ç—à–∞ –∏ –¥–∂–∏—Ç—Ç–µ—Ä TTL.  
> –¢–∞–∫–∂–µ –≤–Ω–µ–¥—Ä–∏–ª –ø–∞—Ç—Ç–µ—Ä–Ω stale-while-revalidate ‚Äî –µ—Å–ª–∏ –∫—ç—à —É—Å—Ç–∞—Ä–µ–ª, –æ—Ç–¥–∞—ë–º —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ, –∞ –Ω–æ–≤—ã–µ –ø–æ–¥–≥—Ä—É–∂–∞–µ–º –≤ —Ñ–æ–Ω–µ.
> 
> –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –±–∞–∑—É —Å—Ç–∞–±–∏–ª–∏–∑–∏—Ä–æ–≤–∞–ª–∞—Å—å, latency —Å–Ω–∏–∑–∏–ª—Å—è –ø—Ä–∏–º–µ—Ä–Ω–æ –Ω–∞ 40%, –∏ –º—ã –≤–Ω–µ–¥—Ä–∏–ª–∏ —ç—Ç–æ—Ç –ø–æ–¥—Ö–æ–¥ –≤–æ –≤—Å–µ –Ω–∞—à–∏ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã.


# –ê–Ω—Ç–∏—Ñ—Ä–æ–¥

**–°–∏—Ç—É–∞—Ü–∏—è:**  
–í –Ω–∞—à–µ–π –∞–Ω—Ç–∏—Ñ—Ä–æ–¥-–ø–æ–¥—Å–∏—Å—Ç–µ–º–µ –¢-–ë–∞–Ω–∫–∞ –º—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ–±—ã—Ç–∏—è –æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è—Ö –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ —á–µ—Ä–µ–∑ Kafka.  
–í –æ–¥–∏–Ω –º–æ–º–µ–Ω—Ç –Ω–∞—á–∞–ª–∏ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–µ—Ä–∂–∫–∏ –≤ –ø—Ä–∏–Ω—è—Ç–∏–∏ —Ä–µ—à–µ–Ω–∏–π: –∞–Ω—Ç–∏—Ñ—Ä–æ–¥-–ø—Ä–æ–≤–µ—Ä–∫–∏ —à–ª–∏ –¥–æ–ª—å—à–µ, —á–µ–º SLA ‚Äî –¥–æ 3‚Äì5 —Å–µ–∫—É–Ω–¥ –≤–º–µ—Å—Ç–æ 300 –º—Å.  
–ò–∑-–∑–∞ —ç—Ç–æ–≥–æ —á–∞—Å—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–π –∑–∞–≤–∏—Å–∞–ª–∞ –≤ —Å—Ç–∞—Ç—É—Å–µ _pending_, –∫–ª–∏–µ–Ω—Ç—ã –≤–∏–¥–µ–ª–∏ ‚Äú–ø–ª–∞—Ç—ë–∂ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –¥–æ–ª—å—à–µ –æ–±—ã—á–Ω–æ–≥–æ‚Äù.

**–ü–æ—á–µ–º—É –∑–∞–¥–∞—á–∞ –±—ã–ª–∞ —Å–ª–æ–∂–Ω–æ–π:**

- –ê–Ω—Ç–∏—Ñ—Ä–æ–¥ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **Kafka + PostgreSQL + –≤–Ω–µ—à–Ω–∏–µ ML-—Å–µ—Ä–≤–∏—Å—ã**, –∏ –ª—é–±–æ–µ —É–∑–∫–æ–µ –º–µ—Å—Ç–æ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç end-to-end latency.
    
- –ù–µ–ª—å–∑—è –±—ã–ª–æ –ø—Ä–æ—Å—Ç–æ ‚Äú–ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å‚Äù ‚Äî —Å–µ—Ä–≤–∏—Å —Å—Ç–æ—è–ª –≤ —Ü–µ–ø–æ—á–∫–µ –ø–ª–∞—Ç–µ–∂–µ–π.
    
- –ü—Ä–æ–±–ª–µ–º–∞ –ø—Ä–æ—è–≤–ª—è–ª–∞—Å—å –Ω–µ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ, –∞ –ø—Ä–∏ –ø–∏–∫–∞—Ö —Ç—Ä–∞—Ñ–∏–∫–∞ –∏ –Ω–µ—Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ –ø–æ –∫–ª–∏–µ–Ω—Ç–∞–º.
    

**–ú–æ–∏ –¥–µ–π—Å—Ç–≤–∏—è:**

1. **–°–Ω–∞—á–∞–ª–∞ —Å–æ–±—Ä–∞–ª –º–µ—Ç—Ä–∏–∫–∏ –∏ —Ç—Ä–µ–π—Å—ã** (Prometheus + Jaeger): —É–≤–∏–¥–µ–ª, —á—Ç–æ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ä–µ–∑–∫–æ —Ä–∞—Å—Ç—ë—Ç –≤ –º–æ–º–µ–Ω—Ç –≤—Å–ø–ª–µ—Å–∫–æ–≤ –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–±—ã—Ç–∏–π –∏–∑ Kafka.
    
2. **–ü—Ä–æ–≤–µ—Ä–∏–ª –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ** ‚Äî –æ–∫–∞–∑–∞–ª–æ—Å—å, —á–∞—Å—Ç—å –∫–ª–∏–µ–Ω—Ç–æ–≤ –ø–æ–ø–∞–ª–∞ –≤ –æ–¥–Ω—É –ø–∞—Ä—Ç–∏—Ü–∏—é, –∏ –∏—Ö —Å–æ–±—ã—Ç–∏—è –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–ª–∏—Å—å –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ (skew).
    
3. **–ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–ª –∫–æ–Ω—Å—å—é–º–µ—Ä** ‚Äî –≤–Ω—É—Ç—Ä–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª –∑–∞–ø—Ä–æ—Å –∫ –≤–Ω–µ—à–Ω–µ–º—É ML-—Å–µ—Ä–≤–∏—Å—É —Å –∑–∞–¥–µ—Ä–∂–∫–∞–º–∏ 800‚Äì900 –º—Å –∏ –∑–∞–ø–∏—Å—å –≤ Postgres.
    
4. –í–Ω—ë—Å –∏–∑–º–µ–Ω–µ–Ω–∏—è:
    
    - –≤—ã–¥–µ–ª–∏–ª –≤—ã–∑–æ–≤ ML-—Å–µ—Ä–≤–∏—Å–∞ –≤ **–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é –ø–æ–¥–∑–∞–¥–∞—á—É** —Å —Ç–∞–π–º–∞—É—Ç–æ–º –∏ fallback-–æ—Ç–≤–µ—Ç–æ–º –∏–∑ Redis-–∫—ç—à–∞;
        
    - –≤–≤—ë–ª **batch-–æ–±—Ä–∞–±–æ—Ç–∫—É —Å–æ–±—ã—Ç–∏–π** –ø–æ 100‚Äì200 –∑–∞–ø–∏—Å–µ–π –≤–º–µ—Å—Ç–æ –æ–¥–∏–Ω–æ—á–Ω—ã—Ö upsert‚Äô–æ–≤;
        
    - —É–≤–µ–ª–∏—á–∏–ª —á–∏—Å–ª–æ –ø–∞—Ä—Ç–∏—Ü–∏–π Kafka –∏ –ø–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏–ª –∫–ª—é—á–∏ (–ø–æ `client_id` –≤–º–µ—Å—Ç–æ `transaction_id`);
        
    - –Ω–∞—Å—Ç—Ä–æ–∏–ª **–∞–≤—Ç–æ—Å–∫–µ–π–ª–∏–Ω–≥ –≤–æ—Ä–∫–µ—Ä–æ–≤** –ø–æ lag‚Äô—É –∏ –º–µ—Ç—Ä–∏–∫–µ CPU.
        
5. –î–æ–±–∞–≤–∏–ª **–∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å** –∏ `retry`-–º–µ—Ö–∞–Ω–∏–∫—É, —á—Ç–æ–±—ã –ø—Ä–∏ —Å–±–æ–µ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–ª–∏—Å—å —Ç–æ–ª—å–∫–æ ‚Äú–≥—Ä—è–∑–Ω—ã–µ‚Äù –∑–∞–ø–∏—Å–∏.
    
6. –í Grafana –ø–æ—Å—Ç–∞–≤–∏–ª –∞–ª–µ—Ä—Ç—ã –Ω–∞ `consumer_lag > 30 —Å–µ–∫` –∏ p95 –æ–±—Ä–∞–±–æ—Ç–∫–∏ > 500 –º—Å.
    

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**

- –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–Ω–∏–∑–∏–ª–æ—Å—å —Å ~3 —Å–µ–∫—É–Ω–¥ –¥–æ ~180 –º—Å.
    
- Lag –≤ Kafka —É–ø–∞–ª –ø–æ—á—Ç–∏ –¥–æ –Ω—É–ª—è –¥–∞–∂–µ –ø—Ä–∏ –ø–∏–∫–∞—Ö –Ω–∞–≥—Ä—É–∑–∫–∏.
    
- –°–∏—Å—Ç–µ–º–∞ —Å—Ç–∞–ª–∞ —É—Å—Ç–æ–π—á–∏–≤–æ–π –∫ –≤—Å–ø–ª–µ—Å–∫–∞–º –∏ –≤—Ä–µ–º–µ–Ω–Ω—ã–º –ø—Ä–æ–±–ª–µ–º–∞–º —Å ML-—Å–µ—Ä–≤–∏—Å–æ–º.
    
- –ù–∞ –æ—Å–Ω–æ–≤–µ —ç—Ç–æ–≥–æ –∫–µ–π—Å–∞ –º—ã —Å–æ–∑–¥–∞–ª–∏ **runbook ‚Äú–∞–Ω–∞–ª–∏–∑ –¥–µ–≥—Ä–∞–¥–∞—Ü–∏–∏ –∞–Ω—Ç–∏—Ñ—Ä–æ–¥–∞‚Äù** –∏ —à–∞–±–ª–æ–Ω –¥–ª—è –Ω–æ–≤—ã—Ö –∫–æ–Ω—Å—å—é–º–µ—Ä–æ–≤.
    

---

## üí¨ –ö–∞–∫ –º–æ–∂–Ω–æ —Å–∫–∞–∑–∞—Ç—å —É—Å—Ç–Ω–æ (–Ω–∞ 40‚Äì50 —Å–µ–∫—É–Ω–¥)

> –í –∞–Ω—Ç–∏—Ñ—Ä–æ–¥-—Å–µ—Ä–≤–∏—Å–µ –º—ã —Å—Ç–æ–ª–∫–Ω—É–ª–∏—Å—å —Å –ø—Ä–æ–±–ª–µ–º–æ–π: –ø—Ä–∏ –ø–∏–∫–∞—Ö –Ω–∞–≥—Ä—É–∑–∫–∏ –≤—Ä–µ–º—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –≤—ã—Ä–æ—Å–ª–æ —Å 300 –º—Å –¥–æ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å–µ–∫—É–Ω–¥, –∏ –ø–ª–∞—Ç–µ–∂–∏ –∑–∞–≤–∏—Å–∞–ª–∏.
> 
> –Ø –ø–æ—Å–º–æ—Ç—Ä–µ–ª –º–µ—Ç—Ä–∏–∫–∏ –∏ –ø–æ–Ω—è–ª, —á—Ç–æ –ø—Ä–∏—á–∏–Ω–∞ ‚Äî –ø–µ—Ä–µ–∫–æ—Å –ø–∞—Ä—Ç–∏—Ü–∏–π Kafka –∏ –º–µ–¥–ª–µ–Ω–Ω—ã–µ –≤—ã–∑–æ–≤—ã –≤–Ω–µ—à–Ω–µ–≥–æ ML-—Å–µ—Ä–≤–∏—Å–∞ –≤–Ω—É—Ç—Ä–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.
> 
> –ú—ã –≤—ã–Ω–µ—Å–ª–∏ ML-–≤—ã–∑–æ–≤ –≤ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é –∑–∞–¥–∞—á—É —Å –∫—ç—à–µ–º, –ø–µ—Ä–µ—à–ª–∏ –Ω–∞ batch-–æ–±—Ä–∞–±–æ—Ç–∫—É –∏ —É–≤–µ–ª–∏—á–∏–ª–∏ —á–∏—Å–ª–æ –ø–∞—Ä—Ç–∏—Ü–∏–π.
> 
> –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ —Å—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —É–ø–∞–ª–æ –¥–æ 180 –º—Å, lag —Å—Ç–∞–±–∏–ª–∏–∑–∏—Ä–æ–≤–∞–ª—Å—è, –∏ –º—ã –¥–æ–±–∞–≤–∏–ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∞–ª–µ—Ä—Ç—ã –∏ runbook –Ω–∞ —Å–ª—É—á–∞–π –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è.


# –î–≤–∏–∂–æ–∫

**–°–∏—Ç—É–∞—Ü–∏—è:**  
–ú—ã —Ä–∞–∑—Ä–∞–±–∞—Ç—ã–≤–∞–ª–∏ –¥–≤–∏–∂–æ–∫ –¥–ª—è **–º—É–ª—å—Ç–∏–∫–∞–Ω–∞–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ç–æ–≤–∞—Ä–Ω—ã—Ö –æ—Å—Ç–∞—Ç–∫–æ–≤** ‚Äî –æ–Ω –æ–±—ä–µ–¥–∏–Ω—è–ª –¥–∞–Ω–Ω—ã–µ –æ —Ç–æ–≤–∞—Ä–∞—Ö –∏–∑ —Ä–∞–∑–Ω—ã—Ö —Å–∏—Å—Ç–µ–º (—Å–∫–ª–∞–¥—ã, –æ–Ω–ª–∞–π–Ω-–≤–∏—Ç—Ä–∏–Ω–∞, –ø–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∏–µ –ø–ª–æ—â–∞–¥–∫–∏) –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–ª –∏—Ö –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏.  
–û–¥–Ω–∞–∂–¥—ã –Ω–∞—á–∞–ª–∏ –ø–æ—Å—Ç—É–ø–∞—Ç—å –∂–∞–ª–æ–±—ã: –¥–∞–Ω–Ω—ã–µ –æ –Ω–∞–ª–∏—á–∏–∏ —Ç–æ–≤–∞—Ä–∞ —Ä–∞—Å—Ö–æ–¥–∏–ª–∏—Å—å –º–µ–∂–¥—É –∫–∞–Ω–∞–ª–∞–º–∏.  
–ù–∞ —Å–∫–ª–∞–¥–µ —Ç–æ–≤–∞—Ä —É–∂–µ –±—ã–ª, –∞ –Ω–∞ —Å–∞–π—Ç–µ –ø–æ–∫–∞–∑—ã–≤–∞–ª—Å—è ‚Äú–Ω–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏‚Äù ‚Äî –∏ –Ω–∞–æ–±–æ—Ä–æ—Ç.

**–ü–æ—á–µ–º—É –∑–∞–¥–∞—á–∞ –±—ã–ª–∞ —Å–ª–æ–∂–Ω–æ–π:**

- –û–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–∏—Ö–æ–¥–∏–ª–∏ **–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –∏ –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤** (Kafka-—Ç–æ–ø–∏–∫–∏, REST-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏, cron-–ø–∞–∫–µ—Ç—ã).
    
- –ù—É–∂–Ω–æ –±—ã–ª–æ –æ–±–µ—Å–ø–µ—á–∏—Ç—å **—Å—Ç—Ä–æ–≥—É—é –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å** –æ—Å—Ç–∞—Ç–∫–æ–≤ –ø—Ä–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è—Ö –∏–∑ –¥–µ—Å—è—Ç–∫–æ–≤ –ø–æ—Ç–æ–∫–æ–≤.
    
- –ü—Ä–∏ —ç—Ç–æ–º –Ω–µ–ª—å–∑—è –±—ã–ª–æ ‚Äú–ø—Ä–∏—Ç–æ—Ä–º–æ–∑–∏—Ç—å‚Äù —Å–∏—Å—Ç–µ–º—É: SLA –ø–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –±—ã–ª <1 —Å–µ–∫, –æ–±—ä—ë–º —Å–æ–±—ã—Ç–∏–π ‚Äî —Å–æ—Ç–Ω–∏ —Ç—ã—Å—è—á –≤ –º–∏–Ω—É—Ç—É.
    

**–ú–æ–∏ –¥–µ–π—Å—Ç–≤–∏—è:**

1. **–°–Ω–∞—á–∞–ª–∞ —Å–æ–±—Ä–∞–ª –º–µ—Ç—Ä–∏–∫–∏:** –ø–æ—Å–º–æ—Ç—Ä–µ–ª Grafana-–¥–∞—à–±–æ—Ä–¥—ã –ø–æ lag, –æ—à–∏–±–∫–∞–º –∏ –≤—Ä–µ–º–µ–Ω–∏ –∑–∞–ø–∏—Å–∏ –≤ Postgres.  
    –£–≤–∏–¥–µ–ª, —á—Ç–æ —á–∞—Å—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π —Ç–µ—Ä—è–µ—Ç—Å—è –ø—Ä–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–π –∑–∞–ø–∏—Å–∏ –æ—Å—Ç–∞—Ç–∫–æ–≤ –ø–æ –æ–¥–Ω–æ–º—É SKU —Å —Ä–∞–∑–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤.
    
2. **–ü—Ä–æ–≤–µ—Ä–∏–ª –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É:** –∫–∞–∂–¥—ã–π –∫–æ–Ω—Å—å—é–º–µ—Ä Kafka –ø–∏—Å–∞–ª –≤ –æ–±—â—É—é —Ç–∞–±–ª–∏—Ü—É `stocks`, –±–µ–∑ —è–≤–Ω–æ–π –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏–∏ ‚Äî –≤–æ–∑–Ω–∏–∫–∞–ª–∏ **–≥–æ–Ω–∫–∏ –ø—Ä–∏ upsert‚Äô–∞—Ö**.
    
3. **–†–µ–∞–ª–∏–∑–æ–≤–∞–ª –º–µ—Ö–∞–Ω–∏–∑–º –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏ –∏ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏:**
    
    - –î–æ–±–∞–≤–∏–ª `version` (–∏–ª–∏ `event_time`) –Ω–∞ –∫–∞–∂–¥–æ–µ —Å–æ–±—ã—Ç–∏–µ.
        
    - –ü—Ä–∏ –∑–∞–ø–∏—Å–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –æ—Å—Ç–∞—Ç–æ–∫ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø—Ä–∏—à–ª–∞ **–Ω–æ–≤–µ–µ –≤–µ—Ä—Å–∏—è** (`ON CONFLICT DO UPDATE WHERE excluded.version > stocks.version`).
        
    - –î–ª—è –≤–Ω–µ—à–Ω–∏—Ö –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤ ‚Äî idempotent-–∫–ª—é—á (`source_id + event_id`), —á—Ç–æ–±—ã –Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–∏.
        
4. **–í–Ω—ë—Å –æ—á–µ—Ä–µ–¥—å –Ω–∞ —É—Ä–æ–≤–Ω–µ Redis** –¥–ª—è –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ —á–∞—Å—Ç—ã—Ö —Å–æ–±—ã—Ç–∏–π –ø–æ –æ–¥–Ω–æ–º—É SKU –∏ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è –∏—Ö –≤ batch-–∑–∞–ø–∏—Å—å.
    
5. **–î–æ–±–∞–≤–∏–ª —Å–ª–æ–π ‚Äúfinalizer‚Äù** ‚Äî –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –≤–æ—Ä–∫–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π –∫–∞–∂–¥—ã–µ N —Å–µ–∫—É–Ω–¥ —Å—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–∞–Ω–∞–ª–æ–≤ –∏ –ø—Ä–∏ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–∏ –∏–Ω–∏—Ü–∏–∏—Ä—É–µ—Ç –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ.
    
6. –ù–∞—Å—Ç—Ä–æ–∏–ª –∞–ª–µ—Ä—Ç—ã –Ω–∞ —Ä–æ—Å—Ç —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–π (`delta_count > threshold`) –∏ –º–µ—Ç—Ä–∏–∫–∏ –ø–æ –≤–µ—Ä—Å–∏–∏ –¥–∞–Ω–Ω—ã—Ö.
    

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**

- –ü–æ–ª–Ω–æ—Å—Ç—å—é —É—Å—Ç—Ä–∞–Ω–∏–ª–∏ —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –º–µ–∂–¥—É –∫–∞–Ω–∞–ª–∞–º–∏.
    
- –í—Ä–µ–º—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ —Å–æ–∫—Ä–∞—Ç–∏–ª–æ—Å—å —Å 10‚Äì15 —Å–µ–∫ –¥–æ 800‚Äì900 –º—Å.
    
- –ù–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –±–∞–∑—É —Å–Ω–∏–∑–∏–ª–∞—Å—å –Ω–∞ 40% –∑–∞ —Å—á—ë—Ç batch-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–π.
    
- Lag –≤ Kafka —Å—Ç–∞–±–∏–ª–∏–∑–∏—Ä–æ–≤–∞–ª—Å—è, –Ω–∏ –æ–¥–Ω–æ–≥–æ ‚Äú–ø–µ—Ä–µ–ø—Ä—ã–≥–∏–≤–∞–Ω–∏—è‚Äù –≤–µ—Ä—Å–∏–π –Ω–µ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ.
    
- –ù–∞ –æ—Å–Ω–æ–≤–µ —ç—Ç–æ–≥–æ —Å–¥–µ–ª–∞–ª–∏ –æ–±—â–∏–π –ø–∞—Ç—Ç–µ—Ä–Ω ‚Äúversioned-upsert‚Äù –¥–ª—è –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤, —Ä–∞–±–æ—Ç–∞—é—â–∏—Ö —Å –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏.
    

---

## üí¨ –ö–∞–∫ –º–æ–∂–Ω–æ —Å–∫–∞–∑–∞—Ç—å —ç—Ç–æ —É—Å—Ç–Ω–æ (–Ω–∞ 40‚Äì50 —Å–µ–∫—É–Ω–¥)

> –ú—ã –≤ –∫–æ–º–∞–Ω–¥–µ —Ä–∞–∑—Ä–∞–±–∞—Ç—ã–≤–∞–ª–∏ –¥–≤–∏–∂–æ–∫ –¥–ª—è –º—É–ª—å—Ç–∏–∫–∞–Ω–∞–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ç–æ–≤–∞—Ä–Ω—ã—Ö –æ—Å—Ç–∞—Ç–∫–æ–≤ ‚Äî –æ–Ω —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–ª –¥–∞–Ω–Ω—ã–µ –º–µ–∂–¥—É —Å–∫–ª–∞–¥–∞–º–∏, –ø–∞—Ä—Ç–Ω—ë—Ä–∞–º–∏ –∏ –æ–Ω–ª–∞–π–Ω-–≤–∏—Ç—Ä–∏–Ω–æ–π.
> 
> –í –∫–∞–∫–æ–π-—Ç–æ –º–æ–º–µ–Ω—Ç –Ω–∞—á–∞–ª–∏ –≤–æ–∑–Ω–∏–∫–∞—Ç—å —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è ‚Äî —á–∞—Å—Ç—å –∫–∞–Ω–∞–ª–æ–≤ –ø–æ–∫–∞–∑—ã–≤–∞–ª–∞ —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ –¥–∞–Ω–Ω—ã–µ.
> 
> –Ø –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª –º–µ—Ç—Ä–∏–∫–∏ –∏ –ø–æ–Ω—è–ª, —á—Ç–æ –ø—Ä–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è—Ö —Ä–∞–∑–Ω—ã–µ –ø–æ—Ç–æ–∫–∏ –∑–∞—Ç–∏—Ä–∞—é—Ç –¥—Ä—É–≥ –¥—Ä—É–≥–∞.
> 
> –†–µ–∞–ª–∏–∑–æ–≤–∞–ª –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –∏ version-upsert: –∫–∞–∂–¥–æ–µ —Å–æ–±—ã—Ç–∏–µ —Ç–µ–ø–µ—Ä—å –æ–±–Ω–æ–≤–ª—è–µ—Ç –∑–∞–ø–∏—Å—å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤–µ—Ä—Å–∏—è –Ω–æ–≤–µ–µ.  
> –î–æ–±–∞–≤–∏–ª –∞–≥—Ä–µ–≥–∞—Ü–∏—é —Å–æ–±—ã—Ç–∏–π –≤ Redis –∏ —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä, –∫–æ—Ç–æ—Ä—ã–π –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è.
> 
> –í –∏—Ç–æ–≥–µ –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–ª–∏, –ª–∞–≥ —Å–æ–∫—Ä–∞—Ç–∏–ª—Å—è –¥–æ –º–µ–Ω–µ–µ —Å–µ–∫—É–Ω–¥—ã, –∞ –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –±–∞–∑—É —É–ø–∞–ª–∞ –ø—Ä–∏–º–µ—Ä–Ω–æ –Ω–∞ 40%.